<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Arthas" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/Arthas/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/Arthas/">Arthas</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、Arthas能做什么"><a href="#一、Arthas能做什么" class="headerlink" title="一、Arthas能做什么"></a>一、Arthas能做什么</h1><p>Arthas 是 阿里巴巴最近开源出来的一个针对 java 的工具，主要是针对 java 的问题进行诊断</p>
<p>test1<br>这个工具可以协助你做下面这些事情：</p>
<ol>
<li>这个类是从哪个 jar 包加载而来的？</li>
<li>为什么会报各种类相关的 Exception？</li>
<li>线上遇到问题无法 debug 好蛋疼，难道只能反复通过增加 System.out 或通过加日志再重新发布吗？</li>
<li>线上的代码为什么没有执行到这里？是由于代码没有 commit？还是搞错了分支？</li>
<li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li>
<li>是否有一个全局视角来查看系统的运行状况？</li>
<li>有什么办法可以监控到JVM的实时运行状态？</li>
</ol>
<h1 id="二、安装及启用方式"><a href="#二、安装及启用方式" class="headerlink" title="二、安装及启用方式"></a>二、安装及启用方式</h1><h2 id="1-windows"><a href="#1-windows" class="headerlink" title="1. windows"></a>1. windows</h2><p>适合本地开发环境下使用</p>
<ol>
<li><p>下载</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://search.maven.org/classic/#search%7Cga%7C1%7Cg%3A%22com.taobao.arthas%22%20AND%20a%3A%22arthas-packaging%22">http://search.maven.org/classic/#search%7Cga%7C1%7Cg%3A%22com.taobao.arthas%22%20AND%20a%3A%22arthas-packaging%22</a></p>
</blockquote>
</li>
<li><p>解压后在安装目录中启动cmd</p>
</li>
<li><p>输入<code>jps</code>查看运行中的java进程</p>
</li>
<li><p>输入<code>as.bat &lt;pid&gt;</code>进入该java进程的监控终端</p>
</li>
</ol>
<h2 id="2-Linux"><a href="#2-Linux" class="headerlink" title="2. Linux"></a>2. Linux</h2><p>适合生产环境下使用</p>
<ol>
<li><p>下载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://alibaba.github.io/arthas/arthas-boot.jar</span><br><span class="line"></span><br><span class="line">java -jar arthas-boot.jar --repo-mirror aliyun --use-http</span><br></pre></td></tr></table></figure></li>
<li><p>输入<code>jps</code>查看运行中的java进程</p>
</li>
<li><p>输入<code>./as.sh &lt;pid&gt;</code>进入该java进程的监控终端</p>
</li>
</ol>
<h2 id="3-docker-amp-k8s"><a href="#3-docker-amp-k8s" class="headerlink" title="3. docker&amp;k8s"></a>3. docker&amp;k8s</h2><ol>
<li><p>启动<code>arthas-demo</code>容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name arthas-demo -it hengyunabc/arthas:latest /bin/sh -c &quot;java -jar /opt/arthas/arthas-demo.jar&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>启动<code>arthas-boot</code>来进行诊断</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it arthas-demo /bin/sh -c &quot;java -jar /opt/arthas/arthas-boot.jar&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>诊断docker里的java进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it  $&#123;containerId&#125; /bin/bash -c &quot;wget https://alibaba.github.io/arthas/arthas-boot.jar &amp;&amp; java -jar arthas-boot.jar&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>诊断k8s里容器的java进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it $&#123;pod&#125; --container $&#123;containerId&#125; -- /bin/bash -c &quot;wget https://alibaba.github.io/arthas/arthas-boot.jar &amp;&amp; java -jar arthas-boot.jar&quot;</span><br></pre></td></tr></table></figure>
<p>由于Kubernetes容器环境中因为精简了jre运行时环境导致jdk很多功能受限了，arthas-boot依赖完整的jdk功能，所以需要下载完整的JDK到本地</p>
</li>
</ol>
<h1 id="三、关键实现技术"><a href="#三、关键实现技术" class="headerlink" title="三、关键实现技术"></a>三、关键实现技术</h1><p>attach:jdk1.6新增功能，通过attach机制，可以在jvm运行中，通过pid关联应用</p>
<p>instrument：jdk1.5新增功能，通过instrument俗称javaagent技术，可以修改jvm加载的字节码</p>
<h1 id="四、常用场景"><a href="#四、常用场景" class="headerlink" title="四、常用场景"></a>四、常用场景</h1><h2 id="1-dashboard-jvm监控"><a href="#1-dashboard-jvm监控" class="headerlink" title="1. dashboard jvm监控"></a>1. dashboard jvm监控</h2><p><code>dashboard</code></p>
<p>显示当前系统的实时数据面板，包含：</p>
<ul>
<li>线程：线程id、线程名、所属组别、优先级、线程状态、CPU占用百分比、是否可中断、是否守护线程</li>
<li>内存使用情况：堆内存（年轻代、生存区、老年代）、非堆内存（代码缓存区、元数据区）</li>
<li>GC:垃圾回收次数、垃圾回收时间、标记-清除算法次数、标记-清除算法消耗时间</li>
</ul>
<p>ctrl+c退出监控</p>
<h2 id="2-jad-类反编译"><a href="#2-jad-类反编译" class="headerlink" title="2. jad 类反编译"></a>2. jad 类反编译</h2><p><code>jad &lt;类路径&gt;</code></p>
<p>显示对应的类信息，包含：</p>
<ul>
<li>该类的类加载器</li>
<li>类所在位置（maven引入的类无法找到对应的jar包）</li>
<li>类源代码</li>
</ul>
<h2 id="3-monitor-方法监控"><a href="#3-monitor-方法监控" class="headerlink" title="3. monitor 方法监控"></a>3. monitor 方法监控</h2><p><code>monitor -c 5 &lt;方法所在类路径&gt; &lt;方法名&gt;</code></p>
<p>5秒一次刷新查看方法执行信息：</p>
<ul>
<li>时间戳</li>
<li>方法所在类路径</li>
<li>方法名</li>
<li>总执行次数</li>
<li>成功次数</li>
</ul>
<h2 id="4-tt-方法调用信息"><a href="#4-tt-方法调用信息" class="headerlink" title="4. tt 方法调用信息"></a>4. tt 方法调用信息</h2><p><code>tt -t &lt;方法所在类路径&gt; &lt;方法名&gt;</code></p>
<p>记录方法调用信息，支持事后查看方法调用的参数，返回值，抛出的异常等信息,显示的信息包括：</p>
<ul>
<li>时间戳</li>
<li>方法执行时长</li>
<li>是否执行成功</li>
<li>方法所在类路径</li>
<li>方法名</li>
</ul>
<h2 id="5-watch-查看错误方法的入参和结果"><a href="#5-watch-查看错误方法的入参和结果" class="headerlink" title="5. watch 查看错误方法的入参和结果"></a>5. watch 查看错误方法的入参和结果</h2><p><code>watch &lt;方法所在类路径&gt; &lt;方法名&gt; &#123;params[0], throwExp&#125; -e</code></p>
<p>记录错误执行的方法的入参和返回结果，还原错误场景（只显示错误方法信息），显示的信息报错：</p>
<ul>
<li>时间戳</li>
<li>方法执行时长</li>
<li>入参及类型</li>
<li>抛出的异常及异常信息</li>
</ul>
<h2 id="6-trace-查看一次调用涉及子方法的执行时长"><a href="#6-trace-查看一次调用涉及子方法的执行时长" class="headerlink" title="6. trace 查看一次调用涉及子方法的执行时长"></a>6. trace 查看一次调用涉及子方法的执行时长</h2><p><code>trace &lt;方法所在类路径&gt; &lt;方法名&gt;</code></p>
<p>观察方法执行的时候哪个子调用比较慢，最慢的一个方法将标红，显示的信息包括：</p>
<ul>
<li>时间戳</li>
<li>执行的方法</li>
<li>方法花费的时间</li>
</ul>
<h2 id="7-redefine-排查奇怪日志来源"><a href="#7-redefine-排查奇怪日志来源" class="headerlink" title="7. redefine 排查奇怪日志来源"></a>7. redefine 排查奇怪日志来源</h2><ul>
<li><p>由于日志是基于SpringBuilder的所以重写它的toString()方法</p>
</li>
<li><p>判断是否包含奇怪日志内容，包含则抛异常输出当前栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String result = <span class="keyword">new</span> String(value, <span class="number">0</span>, count);</span><br><span class="line">    <span class="keyword">if</span>(result.contains(<span class="string">&quot;======UserName:&quot;</span>)) &#123;</span><br><span class="line">           System.err.println(result);</span><br><span class="line">           <span class="keyword">new</span> Throwable().printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>编译重写的StringBuilder.java方法生产.class文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac StringBuilder.java</span><br></pre></td></tr></table></figure></li>
<li><p>使用readfine重新加载外部class文件替换jvm已加载的类</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redefine -p /tmp/StringBuilder.class</span><br></pre></td></tr></table></figure>
<p>也可以结合jad(反编译)/mc(编译)实现在线项目的代码更新，但其直接修改线上产品编译代码会导致和git仓库代码不一致的情况，一般使用jenkins。</p>
</li>
</ul>
<h1 id="五、其他命令"><a href="#五、其他命令" class="headerlink" title="五、其他命令"></a>五、其他命令</h1><h2 id="1-基本命令"><a href="#1-基本命令" class="headerlink" title="1. 基本命令"></a>1. 基本命令</h2><p>help——查看命令帮助信息<br>cls——清空当前屏幕区域<br>session——查看当前会话的信息<br>reset——重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端关闭时会重置所有增强过的类<br>version——输出当前目标 Java 进程所加载的 Arthas 版本号<br>quit——退出当前 Arthas 客户端，其他 Arthas 客户端不受影响<br>shutdown——关闭 Arthas 服务端，所有 Arthas 客户端全部退出<br>keymap——Arthas快捷键列表及自定义快捷键</p>
<h2 id="2-jvm相关"><a href="#2-jvm相关" class="headerlink" title="2. jvm相关"></a>2. jvm相关</h2><p>dashboard——当前系统的实时数据面板<br>thread——查看当前 JVM 的线程堆栈信息<br>jvm——查看当前 JVM 的信息<br>sysprop——查看和修改JVM的系统属性<br>New! getstatic——查看类的静态属性</p>
<h2 id="3-class-classloader相关"><a href="#3-class-classloader相关" class="headerlink" title="3. class/classloader相关"></a>3. class/classloader相关</h2><p> sc——查看JVM已加载的类信息<br>sm——查看已加载类的方法信息<br>dump——dump 已加载类的 byte code 到特定目录<br>redefine——加载外部的.class文件，redefine到JVM里<br>jad——反编译指定已加载类的源码<br>classloader——查看classloader的继承树，urls，类加载信息，使用classloader去getResource</p>
<h2 id="4-monitor-watch-trace相关"><a href="#4-monitor-watch-trace相关" class="headerlink" title="4. monitor/watch/trace相关"></a>4. monitor/watch/trace相关</h2><p>这些命令，都通过字节码增强技术来实现的，会在指定类的方法中插入一些切面来实现数据统计和观测，因此诊断结束要执行 <code>shutdown</code> 或将增强过的类执行 <code>reset</code> 命令。</p>
<p>monitor——方法执行监控<br>watch——方法执行数据观测<br>trace——方法内部调用路径，并输出方法路径上的每个节点上耗时<br>stack——输出当前方法被调用的调用路径<br>tt——方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/Arthas/" data-id="ckk50ch9c0000egmz7i70ewmp" data-title="Arthas" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">框架及中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-COLA" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/COLA/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/COLA/">COLA</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>一、COLA框架解决了哪些问题</p>
<ul>
<li>应用的层次结构混乱：不知道应用应该如何分层、应该包含哪些组件、组件之间的关系是什么；</li>
<li>缺少规范的指导和约束：新加一段业务逻辑不知道放在什么地方（哪个类，哪个包）、应该起什么名字比较合适？</li>
</ul>
<p>二、COLA2.0中的组件</p>
<p>模块和组件的定义</p>
<p>模块（Module）： 和Maven中Module定义保持一致，简单理解就是Jar。</p>
<p>组件（Component）：和UML中的定义类似，简单理解就是Package。</p>
<p>cola中模块和组件的关系</p>
<ol>
<li>Client二方库模块<ul>
<li>api:存放的是应用对外的接口</li>
<li>dto.domainmodel：用来做数据传输的轻量级领域对象</li>
<li>dto.domainevent: 用来做数据传输的领域事件</li>
</ul>
</li>
<li>Application模块<ul>
<li>service：接口实现的facade，没有业务逻辑，可以包含对不同终端的adapter</li>
<li>eventhandler：处理领域事件，包括本域的和外域的</li>
<li>executor：用来处理命令（Command）和查询（Query），对复杂业务，可以包含Phase和Step</li>
<li>interceptor: COLA提供的对所有请求的AOP处理机制</li>
</ul>
</li>
<li>Domain模块<ul>
<li>domain：领域实体，允许继承domainmodel</li>
<li>domainservice: 领域服务，用来提供更粗粒度的领域能力</li>
<li>gateway：对外依赖的网关接口，包括存储、RPC、Search等</li>
</ul>
</li>
<li>Infrastructure<ul>
<li>config：配置信息相关</li>
<li>message：消息处理相关</li>
<li>repository：存储相关，是gateway的特化，主要用来做本域的数据CRUD操作</li>
<li>gateway：对外依赖的网关接口（Domain里的gateway）的实现</li>
</ul>
</li>
</ol>
<p>三、COLA中业务定位的设计</p>
<p>业务身份的三个概念：</p>
<ol>
<li>业务就是一个自负盈亏的财务主体，比如tmall、淘宝和零售通就是三个不同的业务。</li>
<li>用例描述了用户和系统之间的互动，每个用例提供了一个或多个场景。比如，支付订单就是一个典型的用例</li>
<li>场景场景也被称为用例的实例（Instance），包括用例所有的可能情况（正常的和异常的）。比如对于“订单支付”这个用例，就有“可以使用花呗”，“支付宝余额不足”，“银行账户余额不足”等多个场景</li>
</ol>
<p>四、项目结构及请求流程</p>
<ol>
<li>项目结构</li>
</ol>
<p>cola-framework</p>
<pre><code>cola-common

cola-core

cola-test</code></pre>
<p>sample</p>
<pre><code>app-&gt;client、domain

client-&gt;cola-common（可以定义在cola-framework中）

controller-&gt;app、cola-test

domain-&gt;infrastructure、client、cola-test

infrastructure-&gt;cola-core、cola-test

start-&gt;controller、cola-test</code></pre>
<ol start="2">
<li><p>请求流程</p>
</li>
<li><p>controller中调用client中的接口</p>
</li>
<li><p>接口在app中@Service注解下实现(发送消息到命令总线)</p>
</li>
<li><p>app中从命令总线读取命令执行（需要实现CommandExecutorI接口并加@Command注解）</p>
</li>
<li><p>app执行命令时</p>
<ul>
<li>对于复杂业务可以多抽离一层Repository层</li>
<li>调用infrastructure中持久层/rpc层操作接口Tunnel</li>
<li>调用domain实体的方法进行领域内操作</li>
<li>调用infrastructure中DomainEventPublisher将事件发布到事件总线</li>
<li>事件总线中的消息在app@EventHandler标注的事件处理器中处理<ul>
<li>处理时需要调用client中Service方法(实现方法同样在app中，执行发送命令)</li>
<li>对于简单业务可以直接调用infrastructure中Tunnel</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>命令总线和事件总线发布方和处理方的绑定关系通过参数来区分，两个总线的区别是 命令总线是同步的，而事件总线是异步的。</p>
<p>五、实体类定义位置及用法</p>
<p>六、注解使用</p>
<p>七、COLA项目初始化流程</p>
<ol>
<li>在infrastructure中定义初始化配置：注册一个Bootstrap Bean，定义扫描的包路径在groupId</li>
<li>调用Bootstrap的初始化方法init();<ul>
<li>init方法先执行包扫描，获取当前包路径下所有子路径，判断文件是否是文件夹，文件夹则迭代调用包扫描方法；如果是文件则将完整的文件路径保存到Set中</li>
<li>再执行注册bean，判断Set里的类是否有PreInterceptor(前置拦截器)、PostInterceptor(后置拦截器)、Command(命令)、Extension(拓展点)、EventHandler(事件处理器)注解标注，如果有就返回对应的注册器，执行注册</li>
<li>注册到CommandHub（包含全局前置过滤器list,全局后置过滤器list,命令调用map,命令返回类map）<ul>
<li>命令将&lt;Class<Command>,Class<Response>&gt;作为一个map项放入responseRepository中然后创建一个命令调用类，设置执行器为类本身，前置拦截器和后置拦截器，将命令类作为key，命令调用类作为value,放入commandRepository中</li>
<li>前置过滤器、后置过滤器添加到对应的list中</li>
</ul>
</li>
<li>注册到EventHub（包含事件调用map,事件返回类map(空)）<ul>
<li>事件将&lt;Class<DomainEvent>,Class<EventHandler>&gt;存入eventRepository中</li>
</ul>
</li>
<li>注册到ExtensionRepository(包含拓展点map)<ul>
<li>拓展点将</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>八、模块详解</p>
<ol>
<li>Client二方库模块</li>
</ol>
<p>关于二方库的定位表面上来看，是一个简单问题，因为服务的二方库无外乎就是用来暴露接口和传递数据的DTO。不过，往深层次思考，它并不是一个简单的问题，因为它涉及到不同界限上下文（Bounded Context）之间的协作问题。</p>
<p>如何实现不同域之间的协作，同时又要保证各自领域的概念的完整性？</p>
<ol>
<li>共享内核<br>优点：减少重复建设<br>缺点：团队之间紧耦合</li>
<li>防腐层（ACL）<br>下游和上游之间创建一层转换层<br>优点：完全解耦，各自独立<br>缺点：有一定的转换成本</li>
</ol>
<p>二方库的职责范围是什么？</p>
<ol>
<li>二方库中的domain model也是领域的重要组成部分</li>
<li>在Domain层，可以适当考虑继承二方库中的领域能力，可以继承也可以Wrap</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/COLA/" data-id="ckk50ch9l0001egmz6ghe48pw" data-title="COLA" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">框架及中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-HazelCast、Ignite" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/HazelCast%E3%80%81Ignite/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/HazelCast%E3%80%81Ignite/">HazelCast、Ignite</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、Hazelcast"><a href="#一、Hazelcast" class="headerlink" title="一、Hazelcast"></a>一、Hazelcast</h1><p>开源数据网格(可以理解为分布式的数据结构)，没有服务中心，即使一台服务器宕机也不影响正常工作，数据存储在RAM中，将其分布和复制到一堆机器上，并在其上执行数据<strong>本地</strong>计算(类似sql带有计算，而redis更注重的是简单的数据存储)。</p>
<p>当然hazelcast的功能redis也能实现，hazelcast官方测试结果，在每秒简单请求数达到70w以上时，hazelcast的性能明显优于redis；另外hazelcast对开发者十分友好，可以直接像使用jdk自带数据结构一样使用分布式数据结构，扩展也十分方便</p>
<h2 id="1-数据结构及用法"><a href="#1-数据结构及用法" class="headerlink" title="1. 数据结构及用法"></a>1. 数据结构及用法</h2><p>Hazelcast 有两种类型的分布式数据结构：分区数据结构 和 非分区数据结构，分区数据结构一个分区只保存部分数据，非分区数据结构一个分区保存全部的数据，以下为分区数据结构的为：Map、MultiMap、Cache、Event Journal</p>
<ul>
<li>Map ：<code>java.util.Map</code> 的分布式实现</li>
<li>Queue：<code>java.util.concurrent.BlockingQueue</code> 的分布式实现</li>
<li>Ringbuffer：Java中没有对应的数据结构，通常用于可靠的事件系统</li>
<li>Set：<code>java.util.Set</code> 的分布式并发实现</li>
<li>List：<code>java.util.List</code> 的分布式并发实现，支持存储重复元素</li>
<li>Multimap：<code>com.google.common.collect.Multimap</code> 的分布式实现，支持存储重复键(值是一个列表)</li>
<li>Replicated Map：不支持分区的Map数据结构，集群所有成员都有全量数据</li>
<li>Cardinality Estimator：实现类 lajolet’s HyperLogLog 算法的数据结构</li>
<li>Event Journal(特殊)：用于存储map或缓存上操作的历史记录</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hazelcast.jet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hazelcast-jet<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;hazelcast-jet.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>分布式Map:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Config config = <span class="keyword">new</span> Config();</span><br><span class="line">HazelcastInstance h = Hazelcast.newHazelcastInstance(config);</span><br><span class="line">ConcurrentMap&lt;String,String&gt; map = h.getMap(<span class="string">&quot;my-distributed-map&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">map.putifAbsent(<span class="string">&quot;somekey&quot;</span>,<span class="string">&quot;somevalue&quot;</span>);</span><br><span class="line">map.replace(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>,<span class="string">&quot;newvalue&quot;</span>);</span><br><span class="line"></span><br><span class="line">map.forEach((k,v)-&gt;System.out.println(k+<span class="string">&quot;=&gt;&quot;</span>+v));</span><br><span class="line">map.destory();	<span class="comment">//destory后如果接着通过这个引用访问会重新构建对象</span></span><br><span class="line">h.shutdown();</span><br></pre></td></tr></table></figure>
<p>分布式Topic:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedTopic</span> <span class="keyword">implements</span> <span class="title">MessageListener</span>&lt;<span class="title">String</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HazelcastInstance h;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        HazelcastInstance h = Hazelcast.newHazelcastInstance(config);</span><br><span class="line">        ITopic&lt;String&gt; topic = h.getTopic(<span class="string">&quot;my-distributed-topic&quot;</span>);</span><br><span class="line">        topic.addMessageListener(<span class="keyword">new</span> DistributedTopic());</span><br><span class="line">        topic.publish(<span class="string">&quot;Hello to distributed world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message&lt;String&gt; message)</span></span>&#123;</span><br><span class="line">        System.out.prinltn(<span class="string">&quot;Got message &quot;</span> + message.getMessageObject());</span><br><span class="line">        h.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>spring项目里一般把HazelcastInstance定义为一个SpringBean</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hazelcast:</span></span><br><span class="line">  <span class="attr">self-setting:</span> <span class="literal">false</span> <span class="comment">#如果该配置为false使用内网自动发现</span></span><br><span class="line">  <span class="comment">#多种网络环境均开启只会启用第一个</span></span><br><span class="line">  <span class="comment">#主动发现配置</span></span><br><span class="line">  <span class="attr">tcp-ip:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">interface-ex:</span> <span class="number">172.16</span><span class="number">.10</span><span class="string">.*</span></span><br><span class="line">    <span class="attr">members:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.10</span><span class="number">.98</span></span><br><span class="line">  <span class="attr">kubernetes:</span>  <span class="comment">#k8s部署环境网络发现</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-dns:</span> <span class="string">power-match.dev.svc.cluster.local</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;hazelcast&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span>  <span class="title">HazelcastSetting</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否使用自定义配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean selfSetting;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主动发现网络配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TcpIpSetting tcpIp;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> K8sSetting kubernetes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@DependsOn(&quot;hazelcastSetting&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HazelcastConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String app_name = <span class="string">&quot;match&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @Value(&quot;$&#123;spring.profiles.active&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String app_active = <span class="string">&quot;local&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	HazelcastSetting hazelcastSetting;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Config <span class="title">config</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String instanceKey = app_name + app_active + <span class="string">&quot;-instance&quot;</span>;</span><br><span class="line">		Config config = <span class="keyword">new</span> Config();</span><br><span class="line">		config.setInstanceName(instanceKey);</span><br><span class="line">		networkSetting(config);</span><br><span class="line">		<span class="keyword">return</span> config;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JetInstance <span class="title">jetInstance</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">		JetConfig jConfig = <span class="keyword">new</span> JetConfig();</span><br><span class="line">		jConfig.setHazelcastConfig(config);</span><br><span class="line">		<span class="keyword">return</span> Jet.newJetInstance(jConfig);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> HazelcastInstance <span class="title">hzInstance</span><span class="params">(JetInstance jetInstance)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> jetInstance.getHazelcastInstance();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 网络配置</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> config</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">networkSetting</span><span class="params">(Config config)</span></span>&#123;</span><br><span class="line">		<span class="comment">//未开启自定义网络配置</span></span><br><span class="line">		<span class="keyword">if</span>(Objects.isNull(hazelcastSetting.getSelfSetting())||!hazelcastSetting.getSelfSetting())&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		NetworkConfig network = config.getNetworkConfig();</span><br><span class="line">		JoinConfig join = network.getJoin();</span><br><span class="line">		<span class="comment">//主动发现配置</span></span><br><span class="line">		<span class="keyword">if</span>(Objects.nonNull(hazelcastSetting.getTcpIp())&amp;&amp;hazelcastSetting.getTcpIp().getEnable())&#123;</span><br><span class="line">			TcpIpSetting tcpIpSetting= hazelcastSetting.getTcpIp();</span><br><span class="line">			join.getMulticastConfig().setEnabled(Boolean.FALSE);</span><br><span class="line">			tcpIpSetting.getMembers().forEach(item-&gt;</span><br><span class="line">					join.getTcpIpConfig().addMember(item).setRequiredMember(item).setEnabled(Boolean.TRUE)</span><br><span class="line">			);</span><br><span class="line">			network.getInterfaces().setEnabled(Boolean.TRUE).addInterface(hazelcastSetting.getTcpIp().getInterfaceEx());</span><br><span class="line">			config.setNetworkConfig(network);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//K8s网络发现</span></span><br><span class="line">		<span class="keyword">if</span>(Objects.nonNull(hazelcastSetting.getKubernetes())&amp;&amp;hazelcastSetting.getKubernetes().getEnable())&#123;</span><br><span class="line"></span><br><span class="line">			join.getMulticastConfig().setEnabled(Boolean.FALSE);</span><br><span class="line">			join.getKubernetesConfig().setEnabled(Boolean.TRUE)</span><br><span class="line">					.setProperty(<span class="string">&quot;service-dns&quot;</span>,hazelcastSetting.getKubernetes().getServiceDns());</span><br><span class="line">			config.setNetworkConfig(network);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-包含的工具"><a href="#2-包含的工具" class="headerlink" title="2. 包含的工具"></a>2. 包含的工具</h2><ul>
<li>FencedLock：java 中 <code>java.util.concurrent.locks.Lock</code> 的分布式实现，可以保证集群中只有一个线程可以获得锁</li>
<li>ISemaphore：java 中 <code>java.util.concurrent.Semaphore</code> 的分布式实现</li>
<li>IAtomicLong：java 中 <code>java.util.concurrent.atomic.AtomicLong</code> 的分布式实现</li>
<li>IAtomicReference：java中 <code>java.util.concurrent.atomic.AtomicReference</code> 的分布式实现</li>
<li>FlakeidGenerator：用于生产集群范围内的唯一标识符</li>
<li>ICountdownLatch：Java中 <code>java.util.concurrent.CountDownLatch</code> 的分布式实现</li>
<li>PN counter：一个分布式数据结构，其中每个Hazelcast实例都可以递增和递减计数器值，并将这些更新传播到所有副本</li>
</ul>
<h1 id="二、Ignite"><a href="#二、Ignite" class="headerlink" title="二、Ignite"></a>二、Ignite</h1><p>使用上倾向于内存数据库，功能上和hazelcast类似，Ignite提供了完整的SQL、DDL、DML的支持，可以使用纯sql与Ignite进行交互，并且经过测试，性能全方面优于hazelcast。同时可以通过IgniteWeb控制台对数据进行监控，其索引结构主要是SnapTreeMap，是一种有序线程安全的Map，性能表现优于跳表map</p>
<h2 id="1-使用"><a href="#1-使用" class="headerlink" title="1. 使用"></a>1. 使用</h2><ol>
<li><p>服务下载</p>
<p> <a target="_blank" rel="noopener" href="https://ignite.apache.org/download.cgi">https://ignite.apache.org/download.cgi</a> 下载后有ignite服务和ignitevisorcmd监控界面（启用后输入open-&gt;0-&gt;top）</p>
</li>
<li><p>添加相关依赖</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.ignite<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ignite-spring-data<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--2.8.0之后--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.ignite<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ignite-spring-data_2.2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类加注解</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableIgniteRepositories</span></span><br></pre></td></tr></table></figure></li>
<li><p>定义配置类</p>
<p> 这里使用的是堆外缓存，主要的优点就是避免了堆内存OOM，并减少了GC次数，同时ignite如果分布式部署，需要做内存数据同步，堆内存需要赋值到直接内存再发送，堆外内存避免了这个步骤</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IgniteCfg</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化ignite节点信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Ignite <span class="title">igniteInstance</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        DataRegionConfiguration dataCfg = <span class="keyword">new</span> DataRegionConfiguration();</span><br><span class="line">        dataCfg.setName(<span class="string">&quot;order_offheap_memory&quot;</span>);</span><br><span class="line">        dataCfg.setInitialSize(<span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        dataCfg.setMaxSize(<span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 堆外缓存 最近第二次访问最久 删除策略</span></span><br><span class="line">        dataCfg.setPageEvictionMode(DataPageEvictionMode.RANDOM_2_LRU);</span><br><span class="line">        DataStorageConfiguration memCfg = <span class="keyword">new</span> DataStorageConfiguration();</span><br><span class="line">        memCfg.setDataRegionConfigurations(dataCfg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置一个节点的Configuration</span></span><br><span class="line">        IgniteConfiguration cfg = <span class="keyword">new</span> IgniteConfiguration();</span><br><span class="line">        <span class="comment">// 设置该节点名称</span></span><br><span class="line">        cfg.setIgniteInstanceName(<span class="string">&quot;lsqt-ignite-1&quot;</span>);</span><br><span class="line">        cfg.setDataStorageConfiguration(memCfg);</span><br><span class="line">        <span class="comment">// 启用Peer类加载器sun/misc</span></span><br><span class="line">        cfg.setPeerClassLoadingEnabled(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个Cache的配置</span></span><br><span class="line">        CacheConfiguration&lt;String, MatchOrder&gt; cacheCfg = <span class="keyword">new</span> CacheConfiguration&lt;&gt;(<span class="string">&quot;orderCache&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置这个Cache的键值对模型</span></span><br><span class="line">        cacheCfg.setIndexedTypes(String.class, MatchOrder.class);</span><br><span class="line">        <span class="comment">// 是否启用堆内缓存</span></span><br><span class="line">        cacheCfg.setOnheapCacheEnabled(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 把这个Cache放入springDataNode这个Node中</span></span><br><span class="line">        cfg.setCacheConfiguration(cacheCfg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动这个节点</span></span><br><span class="line">        <span class="keyword">return</span> IgnitionEx.start(cfg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>定义实体类</p>
</li>
<li><p>定义数据仓库</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RepositoryConfig(cacheName = &quot;orderCache&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StringRepository</span> <span class="keyword">extends</span> <span class="title">IgniteRepository</span>&lt;<span class="title">TradeAccount</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-碰到的问题"><a href="#2-碰到的问题" class="headerlink" title="2. 碰到的问题"></a>2. 碰到的问题</h2></li>
<li><p>ignite依赖的h2版本与自带的h2版本不一致的问题(导致配置类空指针异常，仓库找不到等问题)</p>
<p> exclustion ignite自带的h2，换支持版本的h2依赖</p>
</li>
<li><p>ignite-jpa查询条件不存在问题</p>
<p> 在实体类要作为查询条件的字段上加@QuerySqlField注解</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/HazelCast%E3%80%81Ignite/" data-id="ckk50ch9n0002egmzd4k3ad6c" data-title="HazelCast、Ignite" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">框架及中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Shiro、Spring Security" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/Shiro%E3%80%81Spring%20Security/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/Shiro%E3%80%81Spring%20Security/">Shiro、Spring Security</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="权限管理及应用"><a href="#权限管理及应用" class="headerlink" title="权限管理及应用"></a>权限管理及应用</h1><h2 id="一、为什么要使用权限"><a href="#一、为什么要使用权限" class="headerlink" title="一、为什么要使用权限"></a>一、为什么要使用权限</h2><ol>
<li>安全性：误操作、人为破坏、数据泄露等等</li>
<li>数据隔离：不同的权限能看到及操作不同的数据</li>
<li>明确职责：运营、客服等不同角色，leader和dev等不同级别</li>
</ol>
<h2 id="二、怎么去实现权限框架"><a href="#二、怎么去实现权限框架" class="headerlink" title="二、怎么去实现权限框架"></a>二、怎么去实现权限框架</h2><h3 id="2-1-shiro"><a href="#2-1-shiro" class="headerlink" title="2.1 shiro"></a>2.1 shiro</h3><p>Apache Shiro是一个为java程序提供安全的框架。这里的安全就是指程序的认证，程序资源权限方法，以及Session的管理。简而言之，就是框架可以管理认证（登录），权限，session。</p>
<p>让开发者不再关注这一方面，释放自己的开发时间（更加快速的开发java程序）。 </p>
<h4 id="2-1-1-shiro的组成"><a href="#2-1-1-shiro的组成" class="headerlink" title="2.1.1 shiro的组成"></a>2.1.1 shiro的组成</h4><p>Shiro包含了如下三个核心概念：</p>
<ul>
<li><p><strong>Subject</strong>：本质上就是当前访问用户的抽象描述。Shiro对外主要提供了以Subject为核心的一些列API，各种用户验证与权限控制的接口都是围绕着Subject来设计的。 </p>
<p>但是所有Subject都需要SecurityManager，当你与Subject进行交互，这些交互行为实际上被转换为与SecurityManager的交互。 </p>
</li>
<li><p><strong>SecurityManager</strong>：安全管理器，对内管理。管理着所有的Subject，是Shiro的核心，与其他组件交互，例如会话管理，缓存管理</p>
</li>
<li><p><strong>Realm</strong>：意思为领域或者国度，对接资源。起到一个桥梁的作用，主要通过realm来获取用户相关的安全数据，例如获取用户在数据库中的密码信息，角色信息，操作权限信息等。Shiro内置了2个Realm，分别是IniRealm和JdbcRealm，但是不常用，一般情况下都需要我们自己来自定义实现。</p>
</li>
</ul>
<p><img src="D:\Typora\resources\app\asserts\icon\249513814f7a9044240472de33683eaa.png" alt="249513814f7a9044240472de33683eaa"></p>
<p>用户通过Subject来进行认证和授权，而Subject又委托给SecurityManager，而SecurityManager又需要通过我们自定义的Realm来获取密码，权限等数据来进行校验和比对。</p>
<p>​    下面介绍SecurityManager的组成：</p>
<p><img src="D:\Typora\resources\app\asserts\icon\a73fe7847b74f8b4ae238e973d097695.png" alt="a73fe7847b74f8b4ae238e973d097695"></p>
<table>
<thead>
<tr>
<th>功能名称</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>Authenticator</td>
<td>认证功能，主要对用户的登录进行管理</td>
</tr>
<tr>
<td>Authorizer</td>
<td>权限功能，主要对用户的权限进行管理</td>
</tr>
<tr>
<td>SessionManager</td>
<td>主要对用户的session进行管理</td>
</tr>
<tr>
<td>SessionDao</td>
<td>session保存管理功能，主要对用户的session实例进行保存，其实就为了实现seeion集成</td>
</tr>
<tr>
<td>Realms</td>
<td>数据管理功能，上面的认证功能，权限功能都需要和数据库交互，这个就是用来管理数据的</td>
</tr>
<tr>
<td>CacheManger</td>
<td>这个就是缓存，用户，权限，都会被缓存起来 ， 不必每次去查，这样可以提高效率</td>
</tr>
<tr>
<td>Cryptography</td>
<td>加密功能，这个用的比较少（可能就是我吧），封装了一系列加密功能</td>
</tr>
</tbody></table>
<h4 id="2-1-2-SE环境下shiro权限框架的使用"><a href="#2-1-2-SE环境下shiro权限框架的使用" class="headerlink" title="2.1.2 SE环境下shiro权限框架的使用"></a>2.1.2 SE环境下shiro权限框架的使用</h4><ol>
<li><p>导入jar包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;shiro.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>自定义Realm数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService iUserService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *  自定义获取身份校验的信息</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">//获取传入的身份信息封装</span></span><br><span class="line">        <span class="comment">//身份信息(用户名)</span></span><br><span class="line">        String username = authenticationToken.getPrincipal();</span><br><span class="line">        <span class="comment">//凭证信息（密码）</span></span><br><span class="line">        Object credentials = authenticationToken.getCredentials();</span><br><span class="line">        <span class="comment">//获取数据库信息</span></span><br><span class="line">        User user = iUserService.findByUserName(username);</span><br><span class="line">        <span class="comment">//身份校验</span></span><br><span class="line">        <span class="keyword">if</span>(user==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;用户名或密码不正确&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//密码校验</span></span><br><span class="line">        <span class="keyword">if</span>(credentials == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectCredentialsException(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否锁定</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.equals(Stirng.valueOf(user.getLocked()),<span class="string">&quot;1&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedAccountException(<span class="string">&quot;帐号锁定&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String password = <span class="keyword">new</span> String((<span class="keyword">char</span>[])credentials);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将这些校验信息返回，目的是让subject能获取到</span></span><br><span class="line">        SimpleAuthenticationInfo info = <span class="keyword">new</span> SimpleAuthenticationInfo(username,password,getName());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *  获取授权的信息</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取了用户名</span></span><br><span class="line">        String username = (String)principalCollection.getPrimaryPrincipal();</span><br><span class="line">        User user = iUserService.findByUserName(username);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//定义返回的授权信息</span></span><br><span class="line">        SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        <span class="comment">//角色集合</span></span><br><span class="line">        Set&lt;Role&gt; roleSet = <span class="keyword">new</span> HashSet&lt;Role&gt;();</span><br><span class="line">        <span class="comment">//权限集合</span></span><br><span class="line">        Set&lt;String&gt; shiroPermissions = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">        <span class="comment">//获取用户角色</span></span><br><span class="line">        Set&lt;Role&gt; roles = user.getRoles();</span><br><span class="line">        <span class="keyword">for</span>(Role role:roles)&#123;</span><br><span class="line">            Set&lt;Permission&gt; resources = role.getResources();</span><br><span class="line">            <span class="keyword">for</span>(Permission resouce:resources)&#123;</span><br><span class="line">                shiroPermissions.add(resource.getSouceKey());</span><br><span class="line">            &#125;</span><br><span class="line">            roleSet.add(role.getRoleKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>创建一个subject主体对象（对外暴露接口，接纳人）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/admin/login&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span>String username,<span class="meta">@RequestParam(&quot;password&quot;)</span>String password,Model model,HttpSession session)</span></span>&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">//创建一个管理对象</span></span><br><span class="line">DefaultSecurityManager securityManager = <span class="keyword">new</span> DefaultSecurityManager();</span><br><span class="line"><span class="comment">//把自定义realm注册到管理器里面，这里可以传集合，因为有多种校验方式：用户名、手机、邮箱等</span></span><br><span class="line">securityManager.setRealm(<span class="keyword">new</span> MyRealm());</span><br><span class="line">        </span><br><span class="line">SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个subject对象</span></span><br><span class="line">Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line"><span class="comment">//封装用户信息和密码</span></span><br><span class="line">UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username,password);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//登录（身份校验）</span></span><br><span class="line">subject.login(token);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//看我是否有该角色</span></span><br><span class="line">subject.hasRole(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"><span class="comment">//看我是否有该操作权限(多个可以逗号分割，参数为可变数组)</span></span><br><span class="line">subject.isPermitted(<span class="string">&quot;system:user:add&quot;</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//退出</span></span><br><span class="line">subject.logout();</span><br><span class="line">&#125;<span class="keyword">catch</span>（Exception e）&#123;</span><br><span class="line">    model.put(<span class="string">&quot;message&quot;</span>,e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-3-shiro集成spring-boot"><a href="#2-1-3-shiro集成spring-boot" class="headerlink" title="2.1.3 shiro集成spring boot"></a>2.1.3 shiro集成spring boot</h4></li>
<li><p>导入jar包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;shiro.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;shiro.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>shiro配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">shiroConfig</span></span>&#123;</span><br><span class="line">    <span class="comment">//自定义的资源</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;realm&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Realm <span class="title">getRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//MyRealm为上一模块定义</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyRealm(); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//安全管理器</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;securityManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultSecurityManager <span class="title">getSecurityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean(name = &quot;shiroCacheManager&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MemoryConstrainedCacheManager();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  web环境的过滤器工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">getShiroFilterFactory</span><span class="params">(<span class="meta">@Qualifier(&quot;securityManager&quot;)</span> DefaultSecurityManager securityManager,<span class="meta">@Qualifier(&quot;realm&quot;)</span> Realm realm)</span></span>&#123;</span><br><span class="line">        securityManager.setRealm(realm);</span><br><span class="line">        <span class="comment">// 创建过滤器工厂</span></span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 登录信息不存在的时候（跳转的路径）</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 登录成功之后的跳转页面</span></span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">&quot;/admin/index&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 身份校验通过了，但是呢，没有权限的页面</span></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/error1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String,String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// 那些不需要拦截（静态资源）</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/assets/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/admin/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取相应的权限（校验什么权限）</span></span><br><span class="line">        List&lt;Permission&gt; list = iPermissionService.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Permission resource : list) &#123;</span><br><span class="line">        <span class="comment">// permission 权限 perms[]</span></span><br><span class="line">        filterChainDefinitionMap.put(resource.getSourceUrl(), <span class="string">&quot;perms[&quot;</span> + resource.getSourceKey() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 需要校验的路径</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/admin/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>引入freemarker配置包并添加配置</p>
<p>配置包位置：<code>git@github.com:gglaochen/javaUtils.git</code></p>
<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FreeMarkerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> freemarker.template.Configuration configuration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将shiro标签和freemarker标签整合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSharedVariable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            configuration.setSharedVariable(<span class="string">&quot;shiro&quot;</span>, <span class="keyword">new</span> ShiroTags());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>然后可以在freemarker页面通过宏标签进行角色或资源权限的校验</p>
<ul>
<li>是否有资源操作的权限</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;@shiro.hasPermission name=&quot;system:user:index&quot;&gt;</span><br><span class="line">    &lt;li &lt;#if active==&quot;user&quot;&gt;class=&quot;active&quot;&lt;/#if&gt;&lt;/li&gt;</span><br><span class="line">&lt;/@shiro.hasPermission&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取登录用户属性</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&lt;@shiro.principal property=&quot;</span><span class="attr">avatar</span>&quot;/&gt;</span>&quot; class=&quot;img-circle&quot; alt=&quot;User Image&quot;&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>是否拥有某角色</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;@shiro.hasRole name=&quot;role1&quot;&gt;</span><br><span class="line">	用户[&lt;@shiro.principal/&gt;]拥有角色role1<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">&lt;/@shiro.hasRole&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>登录时创建一个subject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &#123;&quot;/admin/login&quot;&#125;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="meta">@RequestParam(&quot;password&quot;)</span> String password,</span></span></span><br><span class="line"><span class="function"><span class="params">                        ModelMap model, HttpSession session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 是不是要创建一个subject对象</span></span><br><span class="line">            Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 封装用户信息和密码</span></span><br><span class="line">            UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username,password);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 身份校验（登录）</span></span><br><span class="line">            subject.login(token);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">&quot;/admin/index&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            model.put(<span class="string">&quot;message&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-1-4-项目演示"><a href="#2-1-4-项目演示" class="headerlink" title="2.1.4 项目演示"></a>2.1.4 项目演示</h4></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/gglaochen/shiro-freemarker">https://github.com/gglaochen/shiro-freemarker</a></p>
<h3 id="2-2-spring-security"><a href="#2-2-spring-security" class="headerlink" title="2.2 spring-security"></a>2.2 spring-security</h3><h4 id="2-2-1-什么是spring-security"><a href="#2-2-1-什么是spring-security" class="headerlink" title="2.2.1 什么是spring-security"></a>2.2.1 什么是spring-security</h4><p>这是一种基于 Spring AOP 和 Servlet 过滤器的安全框架。它提供全面的安全性解决方案，同时在 Web 请求级和方法调用级处理身份确认和授权。</p>
<p>集成完该框架默认情况下，系统帮我们生成一个登陆页，默认除了登陆其他请求都需要进行身份认证，没有身份认证前的任何操作都会跳转到默认登录页。<br>默认生成的密码也会在控制台输出。</p>
<h4 id="2-2-2-用户认证和用户授权"><a href="#2-2-2-用户认证和用户授权" class="headerlink" title="2.2.2 用户认证和用户授权"></a>2.2.2 用户认证和用户授权</h4><p>应用的安全性包括用户认证（Authentication）和用户授权（Authorization）两个部分。</p>
<p><strong>用户认证</strong>指的是验证某个用户是否为系统中的合法主体，也就是说用户能否访问该系统。用户认证一般要求用户提供用户名和密码。</p>
<p><strong>用户授权</strong>指的是验证某个用户是否有权限执行某个操作</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/Shiro%E3%80%81Spring%20Security/" data-id="ckk50ch9p0003egmzf8av7b9c" data-title="Shiro、Spring Security" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">框架及中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-cucumber" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/cucumber/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/cucumber/">cucumber</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、Cucumber简介"><a href="#一、Cucumber简介" class="headerlink" title="一、Cucumber简介"></a>一、Cucumber简介</h1><p>cucumber使用自然语言来描述测试，使得非程序员可以理解他们。<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://docs.cucumber.io/gherkin">Gherkin</a>是这种自然语言测试的简单语法，而Cucumber是可以执行它们的工具。<br>cucumber本质上是使用根据正则表达式来匹配自然语言，然后依次执行对应的方法，以达到测试的目的。</p>
<h1 id="二、Gherkin简介"><a href="#二、Gherkin简介" class="headerlink" title="二、Gherkin简介"></a>二、Gherkin简介</h1><p>Gherkin是自然语言测试的简单语法。<br>一个完整的测试是由多个step组成的，step即最小单元，如何复用step是非常关键的问题。多个step组成一个Scenario，即一个完整的测试case。多个Scenario组成一个Feature，即一组相关的测试case。</p>
<h1 id="三、-BDD"><a href="#三、-BDD" class="headerlink" title="三、 BDD"></a>三、 BDD</h1><p>行为驱动开发的根基是一种“通用语言”。这种通用语言同时被客户和开发者用来定义系统的行为。由于客户和开发者使用同一种语言来描述同一个系统， 可以最大程度避免表达不一致带来的问题。</p>
<p><img src="D:\NOTE\images\a.png" alt="a"></p>
<p>BDD并不是一种软件研发方法，而是把现有的工作方法融合起来，让软件研发团队更加高效的工作，从而减轻因软件产品计划延误或功能缺失带来的压力</p>
<h1 id="四、-关键字"><a href="#四、-关键字" class="headerlink" title="四、 关键字"></a>四、 关键字</h1><ul>
<li>Feature：功能</li>
<li>Scenario：场景</li>
<li>Given，When，Then，And，But（steps）：测试步骤（要有对应的步骤方法）</li>
<li>Background：背景</li>
<li>Scenario Outline (or Scenario Template)：场景模板</li>
<li>Examples (or Scenarios)：例子</li>
</ul>
<h1 id="五、使用"><a href="#五、使用" class="headerlink" title="五、使用"></a>五、使用</h1><h2 id="1-添加Maven依赖"><a href="#1-添加Maven依赖" class="headerlink" title="1. 添加Maven依赖"></a>1. 添加Maven依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>info.cukes<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-创建src-test-resources文件夹并定义-feature文件"><a href="#2-创建src-test-resources文件夹并定义-feature文件" class="headerlink" title="2. 创建src/test/resources文件夹并定义.feature文件"></a>2. 创建src/test/resources文件夹并定义.feature文件</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Feature</span>: Is it friday yet?</span><br><span class="line">  this is a descriptions</span><br><span class="line">  Everybody want to know when it&#x27;s Friday</span><br><span class="line"></span><br><span class="line">  <span class="keyword">Scenario</span>: Sunday isn&#x27;t Friday</span><br><span class="line">    <span class="keyword">Given</span> today is Sunday</span><br><span class="line">    <span class="keyword">When</span> I ask whether it&#x27;s Friday yet</span><br><span class="line">    <span class="keyword">Then</span> I should be told <span class="string">&quot;Nope&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">Scenario</span>: Friday is Friday</span><br><span class="line">    <span class="keyword">Given</span> today is Friday</span><br><span class="line">    <span class="keyword">When</span> I ask whether it&#x27;s Friday yet</span><br><span class="line">    <span class="keyword">Then</span> I should be told <span class="string">&quot;TGIF&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="3-定义step-definition"><a href="#3-定义step-definition" class="headerlink" title="3. 定义step definition"></a>3. 定义step definition</h2><p>step definition是指通过正则表达式对应到一个或多个Gherkin step的java方法。如下例子是上面例子对应的step definition。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridayYet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String today;<span class="comment">//通过成员变量</span></span><br><span class="line">    <span class="keyword">private</span> String actualAnswer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Given(&quot;^today is (.*)$&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">todayIsSunday</span><span class="params">(String day)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.today = day;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@When(&quot;^I ask whether it&#x27;s Friday yet$&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">iAskWhetherItsFridayYet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.today.equals(<span class="string">&quot;Friday&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.actualAnswer = <span class="string">&quot;TGIF&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.actualAnswer = <span class="string">&quot;Nope&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Then(&quot;^I should be told \&quot;(.*)\&quot;$&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">iShouldBeToldNope</span><span class="params">(String expectedAnswer)</span> </span>&#123;</span><br><span class="line">        Assert.assertEquals(expectedAnswer, actualAnswer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参数详解"><a href="#参数详解" class="headerlink" title="===参数详解==="></a>===参数详解===</h2><p><strong>feature</strong></p>
<p>Feature是所有测试的开头。后面跟一段描述性的文字，表明这个测试文件是干什么的。</p>
<p><strong>description</strong></p>
<p>description是一段扩展性的文字描述，可以跟在Feature、Example、Background、Scenario、Scenario Outline下面。</p>
<p><strong>Example或Scenario</strong></p>
<p>Example和Scenario是一对同义词，是一个具体的测试case，包含了多个step。一般情况下，都是由Given（给定一个初始条件），When（发生了什么），Then（结果是什么）组成的。</p>
<p><strong>Steps</strong></p>
<p>step是cucubmer的最小单元，每个step是由Given, When, Then, And, 或者But开头的。如果关键词后面的内容是完全一样的话，那么cucumber会认为这两句话是重复的，哪怕前面的关键词不一样，如</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Given</span> there is money in my account</span><br><span class="line"><span class="keyword">Then</span> there is money in my account</span><br></pre></td></tr></table></figure>
<p>这种限制也促使我们使用更加准确的语言去描述</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Given</span> my account has a balance of £430</span><br><span class="line"><span class="keyword">Then</span> my account should have a balance of £430</span><br></pre></td></tr></table></figure>
<p><strong>Given</strong></p>
<p>Given一般用于在Scenario中描述系统的初始状态。它的目的是使系统在使用前处于一个已只的状态，要避免在Given中谈论交互上的事情。</p>
<p><strong>When</strong></p>
<p>When描述一个事件或者动作。他可以是与系统间的交互，也可以是由另一个系统触发的事件。cucumber强烈推荐每个Scenario只有一个When，当你觉得需要加更多的When的时候，通常就是需要拆分成多个Scenario的信号。</p>
<p><strong>Then</strong></p>
<p>Then描述期望的输出或者结果。对Then的step definition应该使用断言去比较期望值和实际值，就和单元测试差不多。</p>
<p><strong>But和And</strong></p>
<p>当有几个Given，When，Then的时候，可以写成</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Example: Multiple Givens</span><br><span class="line">  <span class="keyword">Given</span> one thing</span><br><span class="line">  <span class="keyword">Given</span> another thing</span><br><span class="line">  <span class="keyword">Given</span> yet another thing</span><br><span class="line">  <span class="keyword">When</span> I open my eyes</span><br><span class="line">  <span class="keyword">Then</span> I should see something</span><br><span class="line">  <span class="keyword">Then</span> I shouldn&#x27;t see something else</span><br></pre></td></tr></table></figure>
<p>也可以用And和But增加其可读性</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Example: Multiple Givens</span><br><span class="line">  <span class="keyword">Given</span> one thing</span><br><span class="line">  <span class="keyword">And</span> another thing</span><br><span class="line">  <span class="keyword">And</span> yet another thing</span><br><span class="line">  <span class="keyword">When</span> I open my eyes</span><br><span class="line">  <span class="keyword">Then</span> I should see something</span><br><span class="line">  <span class="keyword">But</span> I shouldn&#x27;t see something else</span><br></pre></td></tr></table></figure>
<p>step definition里个人并不建议使用@And和@But，只使用@Given，@When，@Then，这样语言更加明确，因为And和But都可以在Given，When，Then的下面使用。</p>
<p><strong>Background</strong></p>
<p>当在同一个Feature里有多个Scenario有相同Given的时候，可以使用Background将这些Given抽到一起。这样这个Feature的每个Scenario在运行的时候，都会先运行一次Background。每个Feature里只能有一个Background。</p>
<p>提示：</p>
<ul>
<li>不要设置复杂的状态，除非该状态实际上是客户需要知道的</li>
<li>保持background简短，因为在阅读Scenario的时候，是需要记住background的。最好不要超过4行</li>
<li>一个feature只能有一个background，如果需要不同的background针对不同的方案，就需要分拆成不同的feature</li>
</ul>
<p><strong>Scenario Outline</strong></p>
<p>Scenario Outline即Scenario的模板，也可写作Scenario Template。它可运行相同的Scenario多次。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Scenario</span>: eat 5 out of 12</span><br><span class="line">  <span class="keyword">Given</span> there are 12 cucumbers</span><br><span class="line">  <span class="keyword">When</span> I eat 5 cucumbers</span><br><span class="line">  <span class="keyword">Then</span> I should have 7 cucumbers</span><br><span class="line"></span><br><span class="line"><span class="keyword">Scenario</span>: eat 5 out of 20</span><br><span class="line">  <span class="keyword">Given</span> there are 20 cucumbers</span><br><span class="line">  <span class="keyword">When</span> I eat 5 cucumbers</span><br><span class="line">  <span class="keyword">Then</span> I should have 15 cucumbers</span><br></pre></td></tr></table></figure>
<p>可用Scenario Outline简化</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Scenario</span> <span class="keyword">Outline</span>: eating</span><br><span class="line">  <span class="keyword">Given</span> there are <span class="variable">&lt;start&gt;</span> cucumbers</span><br><span class="line">  <span class="keyword">When</span> I eat <span class="variable">&lt;eat&gt;</span> cucumbers</span><br><span class="line">  <span class="keyword">Then</span> I should have <span class="variable">&lt;left&gt;</span> cucumbers</span><br><span class="line"></span><br><span class="line">  <span class="keyword">Examples</span>:</span><br><span class="line">    |<span class="string"> start </span>|<span class="string"> eat </span>|<span class="string"> left </span>|</span><br><span class="line">    |<span class="string">    12 </span>|<span class="string">   5 </span>|<span class="string">    7 </span>|</span><br><span class="line">    |<span class="string">    20 </span>|<span class="string">   5 </span>|<span class="string">   15 </span>|</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>DataTable</strong></p>
<p>Gherkin可以传递List，Map，称为DataTable，具体例子查看该github上的<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://github.com/cucumber/cucumber/tree/master/datatable">文档</a></p>
<p><strong>方言</strong></p>
<p>Gherkin支持多种方言，对应关键字转换查看该<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://docs.cucumber.io/gherkin/reference/%23spoken-languages">文档</a></p>
<p>中文：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#language: zh-CN</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">| feature          | &quot;功能&quot;       |  </span><br><span class="line">  | background       | &quot;背景&quot;       |  </span><br><span class="line">  | scenario         | &quot;场景&quot;       |  </span><br><span class="line">  | scenario_outline | &quot;场景大纲&quot;    |  </span><br><span class="line">  | examples         | &quot;例子&quot;       |  </span><br><span class="line">  | given            | &quot;* &quot;, &quot;假如&quot; |  </span><br><span class="line">  | when             | &quot;* &quot;, &quot;当&quot;   |  </span><br><span class="line">  | then             | &quot;* &quot;, &quot;那么&quot; |  </span><br><span class="line">  | and              | &quot;* &quot;, &quot;而且&quot; |  </span><br><span class="line">  | but              | &quot;* &quot;, &quot;但是&quot; |  </span><br><span class="line">  | given (code)     | &quot;假如&quot;       |  </span><br><span class="line">  | when (code)      | &quot;当&quot;         |  </span><br><span class="line">  | then (code)      | &quot;那么&quot;       |  </span><br><span class="line">  | and (code)       | &quot;而且&quot;       |  </span><br><span class="line">  | but (code)       | &quot;但是&quot;       | </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在命令行执行cucumber –i18n zh-CN  命令可以查看到以上列表</p>
<p><strong>状态共享</strong></p>
<p>不同step里定义的变量，可以通过java类的成员变量达到共享上下文变量的目的。如上例子的today和actualAnswer。<br>而状态泄露会使得scenarios变得脆弱和难以维护。详细信息查看该<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://docs.cucumber.io/cucumber/state/">文档</a></p>
<p><strong>注释</strong></p>
<p>Gherkin使用#作为注释符号</p>
<p><strong>step definition</strong></p>
<p>step definition是指通过正则表达式对应到一个或多个Gherkin step的java方法。如下例子是上面例子对应的step definition</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class FridayYet &#123;</span><br><span class="line"></span><br><span class="line">    private String today;</span><br><span class="line">    private String actualAnswer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Given(&quot;^today</span> is (.<span class="symbol">*</span>)$<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void todayIsSunday(String day) &#123;</span></span><br><span class="line"><span class="string">        this.today = day;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @When(&quot;</span>^I ask whether it&#x27;s Friday yet$<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void iAskWhetherItsFridayYet() &#123;</span></span><br><span class="line"><span class="string">        if (this.today.equals(&quot;</span>Friday<span class="string">&quot;)) &#123;</span></span><br><span class="line"><span class="string">            this.actualAnswer = &quot;</span>TGIF<span class="string">&quot;;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            this.actualAnswer = &quot;</span>Nope<span class="string">&quot;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @Then(&quot;</span>^I should be told \<span class="string">&quot;(.*)\&quot;$&quot;</span>)</span><br><span class="line">    public void iShouldBeToldNope(String expectedAnswer) &#123;</span><br><span class="line">        Assert.assertEquals(expectedAnswer, actualAnswer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>替代文本</strong></p>
<p>使用/作为替代文本。如下例子可匹配I have {int} cucumber(s) in my belly和I have {int} cucumber(s) in my stomach</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">I have &#123;int&#125; cucumber(s) in my belly/stomach</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3.0.1版本前，无法转义/，始终被解释为替代文本，3.0.1后用/转义/<br>附github<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://github.com/cucumber/cucumber-jvm/blob/master/CHANGELOG.md">版本变更记录</a></p>
<p><strong>tag</strong></p>
<p>tag提供2个作用</p>
<ol>
<li>提供@before和@after的钩子（tagged-hooks）</li>
<li>运行时只运行指定tag的用例<br>tag具有继承特性，即在Feature上标记tag，该Feature下的Scenario，step会继承该tag。</li>
</ol>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@simpleDemo</span></span><br><span class="line"><span class="keyword">Feature</span>: Is it friday yet?</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(Cucumber.class)</span></span><br><span class="line"><span class="meta">@CucumberOptions(tags</span> = <span class="string">&quot;@simpleDemo&quot;</span>)// 指定只运行代用<span class="meta">@simpleDemo的</span></span><br><span class="line">public class CucumberTest &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;</span><span class="meta">@simpleDemo&quot;)</span></span><br><span class="line">public void beforeOperation() &#123;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@After(&quot;</span><span class="meta">@simpleDemo&quot;)</span></span><br><span class="line">public void afterOperation() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试过写两个tag，两个都会生效<br>结合Background具体的运行顺序是 before tag -&gt; Background -&gt; Scenario -&gt; after tag</p>
<p>tips: cucumber.api.spring.SpringTransactionHooks(cucmber-spring包)提供了一个spring事务的钩子@txn，提供回滚功能。</p>
<p><strong>IDE插件</strong></p>
<p>IDEA <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://plugins.jetbrains.com/plugin/7212-cucumber-for-java">Cucumber for Java</a></p>
<h2 id="容易出现的错误"><a href="#容易出现的错误" class="headerlink" title="==容易出现的错误=="></a>==容易出现的错误==</h2><p>step_definition已经实现了.feature文件所有step且不警告（idea自动检测正则表达式匹配，不警告说明表达式已匹配），但测试时仍然报missing steps错误</p>
<p><strong>解决</strong></p>
<p>可能是因为guid路径错误，idea自动生成guid路径，但如果改变了文件名会找不到step_definition</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/cucumber/" data-id="ckk50ch9p0004egmz2rfjdzak" data-title="cucumber" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-graphql" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/graphql/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/graphql/">graphql</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><p>GraphQL 既是一种用于 API 的查询语言也是一个满足你数据查询的运行时。 GraphQL 对你的 API 中的数据提供了一套易于理解的完整描述，使得客户端能够准确地获得它需要的数据，而且没有任何冗余，也让 API 更容易地随着时间推移而演进，还能用于构建强大的开发者工具。</p>
<h1 id="二、和Restful的比较"><a href="#二、和Restful的比较" class="headerlink" title="二、和Restful的比较"></a>二、和Restful的比较</h1><h2 id="1-Restful的一些不足"><a href="#1-Restful的一些不足" class="headerlink" title="1. Restful的一些不足"></a>1. Restful的一些不足</h2><ul>
<li><p>扩展性，单个RESTful接口返回数据越来越臃肿</p>
<p>比如获取用户信息<code>/users/:id</code>，最初可能只有id、昵称，但随着需求的变化，用户所包含的字段可能会越来越多，年龄、性别、头像、经验、等级，等等等等。</p>
<p>而具体到某个前端页面，可能只需要其中一小部分数据，这样就会增加网络传输量，前端获取了大量不必要的数据。</p>
</li>
<li><p>某个前端展现，实际需要调用多个独立的RESTful API才能获取到足够的数据</p>
<p>比如一个文章详情页，最初可能只需要文章内容，那么前端就调用<code>/articles/:aid</code>获取到文章内容来展现就行了</p>
<p>但随着需求的演进，产品可能会希望加上作者信息（昵称、头像等），这时前端又需要在获取文章详情后，根据其中的作者id字段继续获取作者相关的信息，<code>/user/:uid</code></p>
<p>然后，需求又变化了，产品希望在加上这篇文章的评论，这时前端需要继续调用<code>/comment/:aid</code>来拉取评论列表</p>
<p>对于Web前端而言，由于ajax技术的存在，这种的请求数据方式，也就开发上稍微麻烦些，并不会造成太大的问题；但对于App来说，渲染的方式不同，必须要拉取的全部的数据之后，才能绘制界面，就会导致这个界面必须要等到所有3个RESTful接口的返回数据都拿到，才能进行绘制。</p>
</li>
</ul>
<h2 id="2-GraphQL的一些优点"><a href="#2-GraphQL的一些优点" class="headerlink" title="2. GraphQL的一些优点"></a>2. GraphQL的一些优点</h2><ul>
<li><p>所见即所得</p>
<p>查询的返回结果就是输入的查询结构的精确映射</p>
<p>查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    user(uid:1) &#123;</span><br><span class="line">        uid</span><br><span class="line">        name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;user&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>减少网络请求次数</p>
<p>如果设计的数据结构是从属的（例如，上文中文章的作者信息），直接就能在查询语句中指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    article(aid:1) &#123;</span><br><span class="line">        title</span><br><span class="line">        content</span><br><span class="line">        author &#123;</span><br><span class="line">            uid</span><br><span class="line">            name</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即使数据结构是独立的，也可以在查询语句中指定上下文，只需要一次网络请求，就能获得资源和子资源的数据（例如，上文中文章的评论信息）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    article(aid:1) &#123;</span><br><span class="line">        title</span><br><span class="line">        content</span><br><span class="line">        author &#123;</span><br><span class="line">            uid</span><br><span class="line">            name</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    comment &#123;</span><br><span class="line">        content,</span><br><span class="line">        author &#123;</span><br><span class="line">            uid</span><br><span class="line">            name</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>代码即文档</p>
<p>GraphQL会把schema定义和相关的注释生成可视化的文档，从而使得代码的变更，直接就反映到最新的文档上，避免RESTful中手工维护可能会造成代码、文档不一致的问题。</p>
</li>
<li><p>参数类型强校验</p>
<p>RESTful方案本身没有对参数的类型做规定，往往都需要自行实现参数的校验机制，以确保安全。</p>
<p>但GraphQL提供了强类型的schema机制，从而天然确保了参数类型的合法性。</p>
</li>
</ul>
<h2 id="3-GraphQL的局限性"><a href="#3-GraphQL的局限性" class="headerlink" title="3. GraphQL的局限性"></a>3. GraphQL的局限性</h2><p>参数类型受限，如下：</p>
<ul>
<li>Int: 有符号的32位整型</li>
<li>Float: 有符号的双精度浮点型</li>
<li>String: UTF‐8字符序列</li>
<li>Boolean: 布尔型</li>
<li>ID: 常用于获取数据的唯一标志，或缓存的键值，它也会被序列化为String，但可读性差。</li>
<li>枚举类型</li>
<li>对象</li>
<li>集合<code>[]</code></li>
</ul>
<h1 id="三、使用"><a href="#三、使用" class="headerlink" title="三、使用"></a>三、使用</h1><h2 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.graphql-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>graphql-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.graphql-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>graphql-java-tools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-在resource中创建books-graphql文件"><a href="#2-在resource中创建books-graphql文件" class="headerlink" title="2. 在resource中创建books.graphql文件"></a>2. 在resource中创建books.graphql文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">schema &#123;</span><br><span class="line">    query: Query</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Query&#123;</span><br><span class="line">    allBooks : [Book]</span><br><span class="line">    book(id: String): Book</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Book&#123;</span><br><span class="line">    isn: String</span><br><span class="line">    title:String</span><br><span class="line">    publisher:String</span><br><span class="line">    authors: [String]</span><br><span class="line">    publishedDate: String</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="3-定义实体类和Repository方法"><a href="#3-定义实体类和Repository方法" class="headerlink" title="3. 定义实体类和Repository方法"></a>3. 定义实体类和Repository方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String isn;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String publisher;</span><br><span class="line">    <span class="keyword">private</span> String[] authors;</span><br><span class="line">    <span class="keyword">private</span> String publishedDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookReposity</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Book</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-定义BookResource处理请求"><a href="#4-定义BookResource处理请求" class="headerlink" title="4. 定义BookResource处理请求"></a>4. 定义BookResource处理请求</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/rest/books&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookResource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    GraphQLService graphQLService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Object&gt; <span class="title">getAllBooks</span><span class="params">(<span class="meta">@RequestBody</span> String query)</span> </span>&#123;</span><br><span class="line">        ExecutionResult execute = graphQLService.getGraphQL().execute(query);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(execute, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-定义业务层方法"><a href="#5-定义业务层方法" class="headerlink" title="5. 定义业务层方法"></a>5. 定义业务层方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GraphQLService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    BookRepository bookRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:books.graphql&quot;)</span></span><br><span class="line">    Resource resource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GraphQL graphQL;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AllBooksDataFetcher allBooksDataFetcher;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BookDataFetcher bookDataFetcher;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadSchema</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Load Books into the Book Repository</span></span><br><span class="line">        loadDataIntoHSQL();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get the schema</span></span><br><span class="line">        File schemaFile = resource.getFile();</span><br><span class="line">        <span class="comment">// parse schema</span></span><br><span class="line">        TypeDefinitionRegistry typeRegistry = <span class="keyword">new</span> SchemaParser().parse(schemaFile);</span><br><span class="line">        RuntimeWiring wiring = buildRuntimeWiring();</span><br><span class="line">        GraphQLSchema schema = <span class="keyword">new</span> SchemaGenerator().makeExecutableSchema(typeRegistry, wiring);</span><br><span class="line">        graphQL = GraphQL.newGraphQL(schema).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存入数据到BookRepository</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDataIntoHSQL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Stream.of(</span><br><span class="line">                <span class="keyword">new</span> Book(<span class="string">&quot;123&quot;</span>, <span class="string">&quot;Book of Clouds&quot;</span>, <span class="string">&quot;Kindle Edition&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> String[] &#123;</span><br><span class="line">                        <span class="string">&quot;Chloe Aridjis&quot;</span></span><br><span class="line">                        &#125;, <span class="string">&quot;Nov 2017&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> Book(<span class="string">&quot;124&quot;</span>, <span class="string">&quot;Cloud Arch &amp; Engineering&quot;</span>, <span class="string">&quot;Orielly&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> String[] &#123;</span><br><span class="line">                                <span class="string">&quot;Peter&quot;</span>, <span class="string">&quot;Sam&quot;</span></span><br><span class="line">                        &#125;, <span class="string">&quot;Jan 2015&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> Book(<span class="string">&quot;125&quot;</span>, <span class="string">&quot;Java 9 Programming&quot;</span>, <span class="string">&quot;Orielly&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> String[] &#123;</span><br><span class="line">                                <span class="string">&quot;Venkat&quot;</span>, <span class="string">&quot;Ram&quot;</span></span><br><span class="line">                        &#125;, <span class="string">&quot;Dec 2016&quot;</span>)</span><br><span class="line">        ).forEach(book -&gt; &#123;</span><br><span class="line">            bookRepository.save(book);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RuntimeWiring <span class="title">buildRuntimeWiring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RuntimeWiring.newRuntimeWiring()</span><br><span class="line">                .type(<span class="string">&quot;Query&quot;</span>, typeWiring -&gt; typeWiring</span><br><span class="line">                        .dataFetcher(<span class="string">&quot;allBooks&quot;</span>, allBooksDataFetcher)</span><br><span class="line">                        .dataFetcher(<span class="string">&quot;book&quot;</span>, bookDataFetcher))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//定义获取方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GraphQL <span class="title">getGraphQL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> graphQL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="6-执行查询"><a href="#6-执行查询" class="headerlink" title="6. 执行查询"></a>6. 执行查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localhost:8091&#x2F;rest&#x2F;books</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	allBooks&#123;</span><br><span class="line">		isn</span><br><span class="line">		title</span><br><span class="line">		authors</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errors&quot;</span>: [],</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;allBooks&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;isn&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Book of Clouds&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;authors&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;Chloe Aridjis&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;isn&quot;</span>: <span class="string">&quot;124&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Cloud Arch &amp; Engineering&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;authors&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;Peter&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Sam&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;isn&quot;</span>: <span class="string">&quot;125&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Java 9 Programming&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;authors&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;Venkat&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Ram&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;extensions&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>执行条件查询</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	book(id: &quot;123&quot;)&#123;</span><br><span class="line">		isn</span><br><span class="line">		title</span><br><span class="line">		authors</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errors&quot;</span>: [],</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;book&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;isn&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Book of Clouds&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;authors&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;Chloe Aridjis&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;extensions&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>执行多个查询只需要发送一个请求</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	allBooks&#123;</span><br><span class="line">		isn</span><br><span class="line">		title</span><br><span class="line">		authors</span><br><span class="line">	&#125;</span><br><span class="line">	book(id: &quot;123&quot;)&#123;</span><br><span class="line">		isn</span><br><span class="line">		title</span><br><span class="line">		authors</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errors&quot;</span>: [],</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;allBooks&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;isn&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Book of Clouds&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;authors&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;Chloe Aridjis&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;isn&quot;</span>: <span class="string">&quot;124&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Cloud Arch &amp; Engineering&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;authors&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;Peter&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Sam&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;isn&quot;</span>: <span class="string">&quot;125&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Java 9 Programming&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;authors&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;Venkat&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Ram&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;book&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;isn&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Book of Clouds&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;authors&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;Chloe Aridjis&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;extensions&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-别名查询"><a href="#7-别名查询" class="headerlink" title="7. 别名查询"></a>7. 别名查询</h2><p>查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  empireHero: hero(episode: EMPIRE) &#123;</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">  jediHero: hero(episode: JEDI) &#123;</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;empireHero&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Luke Skywalker&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;jediHero&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;R2-D2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面，两个 hero 字段有冲突，但我们可以分别给它们起个别名，这样可以用一个请求就能同时得到这两个结果。</p>
<h2 id="8-执行修改"><a href="#8-执行修改" class="headerlink" title="8. 执行修改"></a>8. 执行修改</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[query(查询)&#x2F;mutation(增删改)&#x2F;subscription(订阅)] 操作名称($isn:ISN(这个可以是&#x3D;赋默认值也可以是变量))&#123;</span><br><span class="line">	book(isn: $isn)&#123;</span><br><span class="line">		code</span><br><span class="line">		message</span><br><span class="line">		data:&#123;</span><br><span class="line">    		isn</span><br><span class="line">    		publisher</span><br><span class="line">    		[authors]</span><br><span class="line">    		publishedDate</span><br><span class="line">    	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和查询的区别是：查询是并行执行，修改是一个接一个地被执行</p>
<h2 id="9-指令：Directives"><a href="#9-指令：Directives" class="headerlink" title="9.指令：Directives"></a>9.指令：Directives</h2><p>使用指令，配合变量，可以动态地改变查询的结构。假设一个界面组件，有一个摘要视图跟详情视图，为这个组件构建一个查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query Hero($episode: Episode, $withFriends: Boolean!) &#123;</span><br><span class="line">  hero(episode: $episode) &#123;</span><br><span class="line">    name</span><br><span class="line">    friends @include(if: $withFriends) &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;episode&quot;: &quot;JEDI&quot;,</span><br><span class="line">  &quot;withFriends&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;hero&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;R2-D2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果把变量中的 withFriends 的值设置成 true，那返回的查询结果应该是：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;hero&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;R2-D2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;friends&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Luke Skywalker&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Han Solo&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Leia Organa&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GraphQL 有两个指令：</p>
<ol>
<li>*@include(if: Boolean)*，如果参数的值是 true 才会在查询结果中包含字段。</li>
<li>*@skip(if: Boolean)*，参数的值如果是 true，忽略这个字段。</li>
</ol>
<h1 id="四、SpringBoot构造器方式使用GraphQL"><a href="#四、SpringBoot构造器方式使用GraphQL" class="headerlink" title="四、SpringBoot构造器方式使用GraphQL"></a>四、SpringBoot构造器方式使用GraphQL</h1><h2 id="1-引入依赖-1"><a href="#1-引入依赖-1" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.leangen.graphql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>graphql-spqr-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-直接通过注解定义GraphQL的操作源"><a href="#2-直接通过注解定义GraphQL的操作源" class="headerlink" title="2. 直接通过注解定义GraphQL的操作源"></a>2. 直接通过注解定义GraphQL的操作源</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GraphQLApi</span><span class="comment">//作为操作源</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@WithResolverBuilder(AnnotatedResolverBuilder.class)</span><span class="comment">//仅公开注释的方法</span></span><br><span class="line"><span class="comment">//@WithResolverBuilder(PublicResolverBuilder.class)//仅公开public操作源类中的所有方法（返回void的方法被认为是mutation）</span></span><br><span class="line"><span class="comment">//@WithResolverBuilder(BeanResolverBuilder.class)//将所有getter暴露为query和setter作为mutation（getters返回Publisher&lt;T&gt;被视为订阅）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    BookReposity bookReposity;</span><br><span class="line"><span class="comment">//    @Resource</span></span><br><span class="line"><span class="comment">//    BookMapper bookMapper;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GraphQLMutation(name = &quot;insertBook&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApiResponse <span class="title">createBook</span><span class="params">(<span class="meta">@GraphQLArgument(name = &quot;book&quot;)</span>Book book)</span></span>&#123;</span><br><span class="line">        bookReposity.save(book);</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GraphQLQuery(name = &quot;allBooks&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;Book&gt; <span class="title">books</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookReposity.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GraphQLQuery(name = &quot;book&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">book</span><span class="params">(String isn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookReposity.findById(isn).get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GraphQLMutation(name = &quot;deleteBook&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApiResponse <span class="title">deleteBook</span><span class="params">(<span class="meta">@GraphQLArgument(name = &quot;id&quot;)</span> String  isn)</span></span>&#123;</span><br><span class="line">        bookReposity.deleteById(isn);</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GraphQLMutation(name = &quot;updateBook&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApiResponse <span class="title">updateBook</span><span class="params">(<span class="meta">@GraphQLArgument(name = &quot;id&quot;)</span> String  isn, <span class="meta">@GraphQLArgument(name = &quot;title&quot;)</span> String  title)</span></span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setIsn(isn);</span><br><span class="line">        book.setTitle(title);</span><br><span class="line">        bookReposity.save(book);</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-可以在实体字段上进行Graph字段的映射"><a href="#3-可以在实体字段上进行Graph字段的映射" class="headerlink" title="3. 可以在实体字段上进行Graph字段的映射"></a>3. 可以在实体字段上进行Graph字段的映射</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GraphQLQuery(name = &quot;orgCode&quot;, description = &quot;机构代码&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String orgCode;</span><br></pre></td></tr></table></figure>
<h2 id="4-可以启用gui进行Graph请求"><a href="#4-可以启用gui进行Graph请求" class="headerlink" title="4. 可以启用gui进行Graph请求"></a>4. 可以启用gui进行Graph请求</h2><p>在application.properties中添加</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8091</span></span><br><span class="line">    <span class="meta">graphql.spqr.gui.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
<p>然后请求<a target="_blank" rel="noopener" href="http://localhost:8091/gui%E8%BF%9B%E5%85%A5Graph%E8%AF%B7%E6%B1%82%E7%95%8C%E9%9D%A2">http://localhost:8091/gui进入Graph请求界面</a></p>
<p>请求</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#删除</span><br><span class="line">mutation&#123;</span><br><span class="line">	deleteBook(id:&quot;123&quot;)&#123;</span><br><span class="line">	code</span><br><span class="line">    message</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">#增加</span><br><span class="line">mutation&#123;</span><br><span class="line">	insertBook(</span><br><span class="line">    book:&#123;</span><br><span class="line">      isn:&quot;123&quot;</span><br><span class="line">      title:&quot;ddd&quot;</span><br><span class="line">      publisher:&quot;人民公社&quot;</span><br><span class="line">      authors: [&quot;chl&quot;]</span><br><span class="line">      publishedDate:&quot;1996-12-13&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  &#123;</span><br><span class="line">		code</span><br><span class="line">    message</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#查询</span><br><span class="line">    query&#123;</span><br><span class="line">        allBooks&#123;</span><br><span class="line">        isn</span><br><span class="line">        title</span><br><span class="line">        &#125;</span><br><span class="line">        book(isn:&quot;124&quot;)&#123;</span><br><span class="line">        isn</span><br><span class="line">        title</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#修改</span><br><span class="line">mutation&#123;</span><br><span class="line">	updateBook(id:&quot;123&quot;,title:&quot;ddd&quot;)&#123;</span><br><span class="line">	code</span><br><span class="line">    message</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/graphql/" data-id="ckk50ch9q0005egmz52aeg3x9" data-title="graphql" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">框架及中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-jvm" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/jvm/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/jvm/">jvm</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、jvm规范内存模型"><a href="#一、jvm规范内存模型" class="headerlink" title="一、jvm规范内存模型"></a>一、jvm规范内存模型</h1><h2 id="1-程序计数器-线程隔离"><a href="#1-程序计数器-线程隔离" class="headerlink" title="1. 程序计数器(线程隔离)"></a>1. 程序计数器(线程隔离)</h2><p>程序计数器可以看作是当前线程所执行的字节码的行号指示器。字节码解释器的工作就是通过改变这个计数器的值来选取下一条需要执行的字节码指令。</p>
<p>一个内核进行线程切换时，需要知道线程的执行位置，所以程序计数器是线程独立的</p>
<h2 id="2-栈-线程隔离"><a href="#2-栈-线程隔离" class="headerlink" title="2. 栈(线程隔离)"></a>2. 栈(线程隔离)</h2><ul>
<li>局部变量表(基础数据类型、对象引用、return地址)</li>
<li>操作数栈</li>
<li>动态链接</li>
<li>方法出口等信息</li>
</ul>
<p>局部变量表所需的内存空间在编译期间完成分配，在运行时不会改变局部变量表的大小</p>
<p><strong>存在的异常</strong></p>
<ol>
<li><code>StackOverflowError</code>线程请求的栈深度大于虚拟机锁允许的深度。</li>
<li><code>OutOfMemoryError</code>虚拟机在动态扩展时，无法申请到足够的内存。</li>
</ol>
<h2 id="3-本地方法栈-线程隔离"><a href="#3-本地方法栈-线程隔离" class="headerlink" title="3. 本地方法栈(线程隔离)"></a>3. 本地方法栈(线程隔离)</h2><p>本地方法栈和栈的区别是：栈为虚拟机执行的Java方法服务，而本地方法栈则为虚拟机使用到的Native方法服务。</p>
<h2 id="4-Java堆-线程共享"><a href="#4-Java堆-线程共享" class="headerlink" title="4. Java堆(线程共享)"></a>4. Java堆(线程共享)</h2><p>此内存区域的唯一目的就是存放对象实例(但不是所有的对象都在堆上分配：栈上分配、标量替换)。</p>
<p>由于现在收集器基本都采用分代收集算法，所以Java堆中还可以细分为</p>
<ul>
<li><code>新生代</code> 包含EdenSpace、From Space、To Space  </li>
<li><code>老年代</code> 一般新对象存在新生代，但如果对象较大会直接存在老年代，老年代GC频率低于新生代</li>
<li><code>永久代</code> JDK8取消了永久代，转而使用元空间，永久代不是jvm规范中概念，而是方法区规范的一种实现，放在这是因为HostSpot虚拟机的垃圾回收器可以像管理Java堆一样管理这部分内存</li>
</ul>
<p><strong>存在的异常</strong></p>
<ol>
<li><code>OutOfMemoryError</code> 堆中没有内存来完成实例的分配，并且堆无法扩展</li>
</ol>
<h2 id="5-方法区-线程共享"><a href="#5-方法区-线程共享" class="headerlink" title="5. 方法区(线程共享)"></a>5. 方法区(线程共享)</h2><p>用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译后的代码等数据</p>
<p>方法区是JVM规范的一个组成部分，而 永久代/元数据 是方法区的一种实现方式</p>
<ul>
<li><code>永久代</code> 容易遇到内存溢出问题，因为永久代有-XX:MaxPermSize的上限 </li>
<li><code>元数据区</code> 独立于JVM，直接存在内存中，只要没有触碰到进程可用内存的上限，就不会OOM</li>
</ul>
<p>Jvm会在反射调用一定次数后动态生成一些类，下次再执行反射的时候，就会直接调用这些类的方法，这是JVM的一个底层优化，如果代码中大量使用反射，JVM会动态生成一些类放入Metaspace区域里，导致频繁FullGC</p>
<h2 id="6-运行时常量池-线程共享"><a href="#6-运行时常量池-线程共享" class="headerlink" title="6. 运行时常量池(线程共享)"></a>6. 运行时常量池(线程共享)</h2><p>运行时常量池是方法区的一部分</p>
<p>Jdk1.6及之前存放在永久代，Jdk1.7之后移到堆内存中</p>
<p>用于存放编译期间生成的各种字面量和符号引用</p>
<p><strong>String和运行时常量池的关系</strong></p>
<ol>
<li><p>String str = “abc”</p>
<p>JDK1.6 : 当常量池中不存在”abc”这个字符串的引用，在堆内存中new一个String对象，复制这个对象加入常量池，返回常量池中的对象的引用；当常量池中存在该对象，str指向这个对象的引用</p>
<p>JDK1.7：当常量池中不存在”abc”这个字符串的引用，在堆内存中new一个新的String对象，将这个对象的引用加入常量池(不再存放对象)；当常量池中存在”abc”这个字符串的引用,返回该引用</p>
</li>
<li><p>String str = new String(“abc”);</p>
<p>单纯在堆内存中new一个String对象，通过StringBuilder跟StringBuffer构建的对象也是一样的</p>
</li>
<li><p>intern方法(1.7版本，返回常量池中该字符串的引用)</p>
<p>当常量池中不存在”abc”这个字符串的引用，将这个对象的引用加入常量池，返回这个对象的引用</p>
<p>当常量池中存在”abc”这个字符串的引用，返回这个对象的引用</p>
</li>
</ol>
<p>所以说</p>
<ol>
<li><p>“abc”=”abc”</p>
<p>jdk1.6相同是因为同一个常量池对象引用</p>
<p>jdk1.7相同是因为是同一个字符串的引用，字符串引用指向堆内存中的”abc”String对象</p>
</li>
<li><p>String a = new String(“abc”);  Assert.isTrue(a != a.intern());</p>
<p>jdk1.6不相同是因为不是同一个对象引用,a是堆中对象的引用,a.intern()是常量区的引用</p>
<p>jdk1.7不相同是因为一个的对象的引用，一个是引用的引用 a是堆中对象的引用,a.intern()是常量区中引用的引用</p>
</li>
</ol>
<h2 id="7-直接内存"><a href="#7-直接内存" class="headerlink" title="7. 直接内存"></a>7. 直接内存</h2><p>直接内存并不是虚拟机运行时数据区的一部分，也不是jvm规范中定义的内存区域。</p>
<p>JDK1.4 加入了NIO(New Input/Output)，引入了一种基于通道与缓冲区的I/O方式，它可以使用Native函数库直接分配堆外内存，然后通过一个存储在堆中的DirectByteBuffer对象作为堆外内存的引用进行操作。因为避免了Java堆和Native堆中来回复制数据，所以显著提高了性能。</p>
<h1 id="二、对象的分配、布局、访问"><a href="#二、对象的分配、布局、访问" class="headerlink" title="二、对象的分配、布局、访问"></a>二、对象的分配、布局、访问</h1><h2 id="1-对象的创建"><a href="#1-对象的创建" class="headerlink" title="1. 对象的创建"></a>1. 对象的创建</h2><ol>
<li><p>类加载检查</p>
<p>虚拟机遇到一条new指令时，首先去检查这个指令的参数是否在常量池中定位到一个类的符号引用，并且检查这个符号引用符号引用代表的类是否已被 加载 、解析 和 初始化 过。如果没有则先执行响应的类加载过程。</p>
</li>
<li><p>分配内存</p>
<p>如何分配内存由垃圾收集器是否带有压缩整理功能决定，有压缩整理功能的使用<code>指针碰撞</code>(Serial、ParNew等)；没有的使用<code>空闲列表</code>方式(CMS)。</p>
<ul>
<li><code>指针碰撞</code> 使用一个指针作为使用过的内存和空间内存的分界点，分配内存就是把指针向空闲内存区域挪动一段和对象大小相等的空间(大小在类加载完成后可以完全确定)</li>
<li><code>空闲列表</code> 记录哪些内存块是可用的，分配的时候在列表中找到一块足够大的空间划分给对象实例</li>
</ul>
<p><strong>如何解决对象创建频繁导致线程不安全的问题？</strong></p>
<ol>
<li>CAS+失败重试   (默认使用的方式)</li>
<li>把内存分配的动作按照线程划分在不同的空间中进行，每个线程在Java堆中预先分配一小块内存，称为<code>本地线程分配缓存</code> (TLAB)，线程在对应的TLAB上分配内存，只有TLAB用完分配新的TLAB时，才需要同步锁定  (可以通过  -XX:+/-UseTLAB 参数来决定是否使用 TLAB)</li>
</ol>
</li>
<li><p>初始化为零值</p>
<p>这一步操作保证了对象的实例字段在Java代码中可以不赋初始值就可以直接使用</p>
</li>
<li><p>设置对象头</p>
<p>包括：这个对象是哪个类的实例，如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄、锁状态标志等信息。</p>
</li>
<li><p>Java程序初始化</p>
<p>执行<init>方法，赋默认值等</p>
</li>
</ol>
<h2 id="2-对象的内存分布"><a href="#2-对象的内存分布" class="headerlink" title="2. 对象的内存分布"></a>2. 对象的内存分布</h2><p>在HotSpot虚拟机中，对象在内存的布局可以分为：对象头、实例数据、对齐填充</p>
<ol>
<li><p>对象头</p>
<ul>
<li>Mark Word ： 存储对象自身的运行时数据（hashCode、GC分代年龄，锁状态标志，线程持有的锁，偏向线程ID，偏向时间戳）</li>
<li>类型指针：对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。</li>
<li>数组长度(如果对象是数组)</li>
</ul>
</li>
<li><p>实例数据</p>
<p>对象真正存储的有效信息，相同宽度的字段会被分配到一起，子类较窄的变量可能会插入到父类变量的间隙之中。</p>
</li>
<li><p>对齐填充</p>
<p>HotSpot VM的自动内存管理系统要求对象初始地址必须是 8 字节的整数倍。对象头是8字节的1/2倍(32/64位虚拟机)，填充的是实例数据部分</p>
</li>
</ol>
<h2 id="3-对象的访问定位"><a href="#3-对象的访问定位" class="headerlink" title="3. 对象的访问定位"></a>3. 对象的访问定位</h2><p>Java程序通过栈上的reference数据来操作具体对象，具体的访问方式由虚拟机决定。主流的访问方式有 使用句柄 和 直接指针 两种</p>
<ul>
<li><p>句柄访问</p>
<p>Java堆会划分出一块内存来作为句柄池，reference中存储的就是对象句柄地址，而句柄中包含了对象实例数据(Java堆)与类型数据(方法区)各自的具体地址</p>
</li>
<li><p>直接指针访问</p>
<p>reference中存储对象实例数据(Java堆)，实例数据包含对象类型数据(方法区)的指针</p>
</li>
</ul>
<p>句柄访问的优点是reference中存储的是稳定的句柄地址，在对象被移动(垃圾收集的时候移动是很普遍的行为)时只需要改变句柄中的实例数据指针，reference本身不需要修改；使用直接指针访问的最大好处是速度快，HotSpot是使用直接指针访问方式的。</p>
<h1 id="三、内存溢出异常"><a href="#三、内存溢出异常" class="headerlink" title="三、内存溢出异常"></a>三、内存溢出异常</h1><p>测试 VM Args:   </p>
<p>-Xms20m    堆最小值</p>
<p>-Xmx20m    堆最大值(将堆最小值和最大值设为一样避免堆自动扩展)</p>
<p>-XX:+HeapDumpOnOutOfMemoryError     虚拟机在出现内存溢出异常时，Dump出当前的内存堆转储快照以便事后进行分析</p>
<p><strong>如何解决问题？</strong></p>
<p>线上问题主要通过看日志、系统状态和dump线程</p>
<h2 id="1-CPU占用率过高"><a href="#1-CPU占用率过高" class="headerlink" title="1. CPU占用率过高"></a>1. CPU占用率过高</h2><ol>
<li><p>在Linux命令行下使用top命令查看每个进程的情况</p>
<p>我们的程序是java应用，所以只需要关注COMMAND是java的性能数据，这里的cpu利用率可能大于100%，这是因为占用了多核cpu</p>
</li>
<li><p>在top交互界面使用命令1可以查看CPU的性能数据</p>
<p>这里可以看到cpu核心数，每个核心的用户空间利用率(us)、内核空间利用率(sy)、改变过优先级的线程占用cpu(ni)</p>
</li>
<li><p>在top交互界面使用命令H可以查看线程的性能信息</p>
<p>这里默认按cpu占用率降序，需要注意的是cpu占满可能是full gc导致，可以通过jstat 命令查看GC情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jstat -gc &lt;pid&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>几个关键参数：</p>
<p>YGC - 年轻代垃圾回收次数</p>
<p>YGCT - 年轻代垃圾回收消耗时间</p>
<p>FGC - 年老代垃圾回收次数</p>
<p>FGCT - 年老代垃圾回收消耗时间</p>
</li>
<li><p>使用jstack，看看是执行什么代码造成CPU利用率高</p>
<p>jstack <pid></p>
<p>入手点：</p>
<p>wait on monitor entry - 被阻塞的，肯定有问题</p>
<p>runnable - 注意IO线程(数据库连接等)</p>
<p>in Object.wait - 注意非线程池等待</p>
</li>
</ol>
<h2 id="2-OOM"><a href="#2-OOM" class="headerlink" title="2. OOM"></a>2. OOM</h2><ol>
<li><p>进入docker容器dump内存关系</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -F -dump:live,file=jmap.hprof [PID] </span><br></pre></td></tr></table></figure></li>
<li><p>拷贝文件到window，使用jvisualvm解析文件，查看是否有异常类占用了过多内存</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp 容器名：要拷贝的文件在容器里面的路径</span><br></pre></td></tr></table></figure></li>
<li><p>如果没异常修改docker容器内存限制mem_limit再查看内存使用状态</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stats</span><br></pre></td></tr></table></figure>
<p> 前提是修改了jvm堆内存的大小是cGroup限制的容器大小</p>
<p> “-XX:+UseCGroupMemoryLimitForHeap”</p>
<p> 否则需要手动配置jvm堆大小</p>
<ul>
<li>JVM_OPTS=-xmx1.5g -xms500m</li>
</ul>
</li>
</ol>
<h1 id="四、GC-overhead-limit-exceeded"><a href="#四、GC-overhead-limit-exceeded" class="headerlink" title="四、GC overhead limit exceeded"></a>四、GC overhead limit exceeded</h1><p>jdk1.6 之后当GC为释放很小空间占用大量时间时会抛出此异常<br>一般是因为堆太小，导致异常的原因：没有足够的内存。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/jvm/" data-id="ckk50ch9r0006egmzcfbqgtr3" data-title="jvm" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java%E5%9F%BA%E7%A1%80/" rel="tag">java基础</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-linux" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/linux/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/linux/">linux</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><p>操作系统是硬件基础上的第一层软件，提供了一些基础的服务程序，如：文件系统、设备驱动程序、用户交互方式接口、系统服务程序(网络服务，运行预定任务等)</p>
<h2 id="1-历史"><a href="#1-历史" class="headerlink" title="1. 历史"></a>1. 历史</h2><p><strong>UNIX、C、TCP/IP</strong></p>
<p>UNIX诞生于20世纪60年代末，由肯·汤普森和丹尼斯·里奇发明，来源追随到1965年的Multics工程计划，由贝尔实验室、麻省理工学院和通用电气公司联合发起，目标是开发一种具有多道程序处理能力的分时操作系统(多用户使用，时间片轮流提供服务)，取代当时的批处理操作系统，但最终失败收场。1969年，肯·汤普森和丹尼斯·里奇吸取教训，开发了UNIX操作系统。</p>
<p>UNIX有很多延伸版本：Sun Solaris、FreeBSD、IBM AIX、HP-UX等</p>
<p>苹果OS X就是基于FreeBSD的操作系统</p>
<p>C语言诞生于1970年，由丹尼斯·里奇开发</p>
<p>TPC/IP协议诞生于20世纪70年代初，由美国国防部开发的网络协议。</p>
<p>至此，UNIX、C、TCP/IP分别在操作系统、编程语言、网络协议三个领域影响至今</p>
<blockquote>
<p>Windows诞生于20世纪80年代中期</p>
</blockquote>
<p><strong>Linux</strong></p>
<p>Linux诞生于20世纪90年代初，最初由李纳斯·托瓦兹在大学时编写，当时仅10000行代码，随后他公开了Linux源代码，邀请其他人一起完善Linux。</p>
<p>据统计，现在仅有2%的LLinux核心代码由李纳斯·托瓦兹自己编写。值得一提的是GitHub也是由李纳斯·托瓦兹编写的。</p>
<blockquote>
<p>开源和闭源的区别</p>
<p>开源项目不代表免费，我们会为之搭配一个满足自己利益的协议，它可以是 GPL、Apache，也可以是 WTF 协议。它可以针对个人免费，但是商用收费，你可以看到项目代码，但并不意味着可以直接商用。</p>
<p>即使开发者选择不收取任何费用，那也就意味着开发者没有义务提供7X24的售后服务，公司需要花更多的钱雇熟练的使用者，同时没人会保证软件背后没有漏洞，需要公司自己承担这一切的风险</p>
</blockquote>
<blockquote>
<p>Linux的图标为什么是企鹅</p>
<p>企鹅是南极洲的标志性动物，根据国际公约，南极洲为全人类共同所有，不属于世界上的任何国家，Linux选择企鹅团作为logo，其含义是：开放源代码的Linux为全人类共同所有，任何公司无权将其私有化</p>
</blockquote>
<p>Linux和UNIX最大的区别：</p>
<p>其一，UNIX系统大多是和硬件配套的，而Linux则可以运行在多种硬件平台上</p>
<p>其二，UNIX是商业软件，Linux是开源软件，免费、公开源码</p>
<h2 id="2-UNIX-Linux系统结构"><a href="#2-UNIX-Linux系统结构" class="headerlink" title="2. UNIX/Linux系统结构"></a>2. UNIX/Linux系统结构</h2><p>大致可以抽象为3层</p>
<ol>
<li><p>系统内核</p>
<p>直接附着在硬件平台之上，控制和挂你系统内各种资源，有效的组织进程的运行，拓展硬件的功能，提高资源的利用率</p>
</li>
<li><p>Shell层(命令解释层)</p>
<p>用户直接交互的界面</p>
</li>
<li><p>应用层</p>
<p>基于X Window协议的图形环境，现在大多数UNIX系统都可以运行CDE（通用桌面环境），Linux也有Gnome、KDE等，但作为服务器部署，绝大多数Linux不会安装图形环境，节省系统资源</p>
</li>
</ol>
<h2 id="3-发行版本"><a href="#3-发行版本" class="headerlink" title="3. 发行版本"></a>3. 发行版本</h2><p>Linux的发行版本可以大体分为两类：一类是商业公司维护的发行版本；另一类是社区组织维护的发行版本。前者以Red Hat为代表，后者以Debian为代表</p>
<ol>
<li><p>Red Hat Linux</p>
<p>Red Hat创建于1003年，是目前世界上自身的Linux厂商，也是最获认可的Linux品牌。其主要产品包括扩RHEL（收费版本）和CentOS（免费版本）、Fedora Core（由Red Hat桌面版发展而来，免费）</p>
<p>国内最常用的是CentOS，是基于RHEL源代码重新编译，去除Red Hat商标的产物，各种操作和付费版本没有区别，且完全免费。缺点是不向用户提供技术支持，且不负任何商业责任</p>
</li>
<li><p>Ubuntu</p>
<p>Ubuntu基于知名的Debian Linux发展而来，界面友好，容易上手，是目前最适合做桌面系统的Linux发行版本，而且免费提供</p>
</li>
</ol>
<p>如果不想配置Linux，只是想要一个比较稳定的服务器系统：CentOS或RHEL</p>
<p>如果只是需要一个桌面系统：Ubuntu</p>
<p>如果想深入摸索一下Linux各个方面的知识，想灵活定制自己的Linux系统：Gentoo</p>
<p>读系统稳定性要求很高：FreeBSD</p>
<h1 id="二、安装"><a href="#二、安装" class="headerlink" title="二、安装"></a>二、安装</h1><h2 id="1-虚拟机"><a href="#1-虚拟机" class="headerlink" title="1. 虚拟机"></a>1. 虚拟机</h2><p>常用的虚拟机软件是VMware，VMware可以使你在一台计算机上同时运行多个操作系统。</p>
<p>VMware推荐使用VMware Workstation Pro或VMware Workstation Player。其中Player版本推荐个人用户使用，非商业用途，是免费的。</p>
<h2 id="2-CentOS"><a href="#2-CentOS" class="headerlink" title="2. CentOS"></a>2. CentOS</h2><ol>
<li><p>LiveCD版和LiveDVD版</p>
<p>提供了 不用安装直接在光盘中体验CentOS的方式。只需插入光盘，并设置BIOS为光盘启动，就可以体验CentOS了</p>
</li>
<li><p>minimal</p>
<p>是精简版，自带软件最少。在服务器上可以使用这个版本。该版本软件最少，系统占用资源较少，被攻击的可能大大降低，但不建议新手使用</p>
</li>
<li><p>netinstall</p>
<p>网络安装版本，需要联结网络，部分程序需要从CentOS官网上下载</p>
</li>
<li><p>Everything/bin</p>
<p>标准CentOS版本，软件较多</p>
</li>
</ol>
<p>下载完操作系统，在VMware上安装操作系统时，如果是宿主机安装，直接指定ISO镜像位置即可</p>
<p><strong>配置分区</strong></p>
<p>分区的主要目的是提升文件的查找效率，分区需要格式化才会生效。</p>
<p>Linux系统必须划分的分区有两个：一个是根分区”/“，另一个是虚拟内存分区”swap”（当系统物理内存不够用的时候，就会将物理内容中的一部分空间释放出来，被移到swap分区中）</p>
<p>除了根分区和swap分区外，其他linux目录也可以单独划分出来</p>
<h1 id="三、入门命令"><a href="#三、入门命令" class="headerlink" title="三、入门命令"></a>三、入门命令</h1><h2 id="1-注意点及建议"><a href="#1-注意点及建议" class="headerlink" title="1. 注意点及建议"></a>1. 注意点及建议</h2><ol>
<li><p>Linux严格区分大小写</p>
</li>
<li><p>Linux中所有内容以文件形式保存，包括硬件设备</p>
<p>windows通过设备管理器来管理硬件，Linux的设备文件保存在/dev/目录中，硬盘文件是/dev/sd[a-p]，光盘文件是/dev/hdc等</p>
</li>
<li><p>Linux不靠扩展名区分文件类型</p>
<p>Linux靠权限位标识来确定文件类型，常见的文件类型只有普通文件、目录、链接文件、块设备文件、字符设备文件等。Linux的可执行文件不过就是普通文件被赋予了可执行权限而已，虽然有的文件有写扩展名，但这些扩展名是为了帮助管理员区分不同的文件类型：tar.gz、zip、rpm、sh等，这些扩展名的作用就是让管理员一目了然</p>
</li>
<li><p>Linux中的所有存储设备都必须在挂载之后才能使用</p>
<p>Linux中的所有存储设备都有自己的设备文件名，这些设备文件必须在挂载之后才能使用。挂载就是给这些存储设备分配盘符，windows中盘符用英文字母表示，而Linux中的盘符是一个已经建立的空目录(挂载点)。把设备文件(如/dev/sdb)和挂载点(已经创建的空目录)连接的过程叫作挂载，后面有详细介绍</p>
</li>
<li><p>Windows下的程序不能直接在Linux中使用</p>
<p>能感染Windows的病毒和木马都对Linux无效。很多软件都会同时推出针对Windows和Linux版本。</p>
</li>
<li><p>不建议强制重启linux</p>
<p>个人计算机强行重启也不会有事，是因为个人计算机没有很多人访问，断电时硬盘没有进行数据交换，如果在硬盘高速存储时断电或重启，非常容易造成硬盘损坏。重启命令前执行几次sync命令，将内存数据同步到硬盘上，重启命令为shutdown -r now</p>
</li>
<li><p>服务器高负载命令建议在凌晨4:00-5:00执行</p>
</li>
<li><p>配置防火墙不要把自己踢出服务器</p>
<p>防火墙指将内网和外网分开，根据数据包的IP地址、端口号和数据包中的数据来判断是否允许数据包通过</p>
</li>
</ol>
<h2 id="2-常见目录及作用"><a href="#2-常见目录及作用" class="headerlink" title="2. 常见目录及作用"></a>2. 常见目录及作用</h2><p>有个规律是bin目录普通用户和root用户都可以执行，sbin目录只有管理员能执行</p>
<table>
<thead>
<tr>
<th>目录名</th>
<th>目录的作用</th>
</tr>
</thead>
<tbody><tr>
<td>/bin/</td>
<td>存放系统命令的目录，普通用户和root都可以执行。命令在单用户模式下也可以执行</td>
</tr>
<tr>
<td>/sbin/</td>
<td>保存与系统环境设置相关的命令，只有root可用使用这些命令配置，但有些命令可以允许普通用户查看</td>
</tr>
<tr>
<td>/usr/bin/</td>
<td>存放系统命令的目录，普通用户和超级用户都可以执行。在单用户模式下不能执行</td>
</tr>
<tr>
<td>/usr/sbin/</td>
<td>只有管理员可以用的系统命令</td>
</tr>
<tr>
<td>/boot/</td>
<td>系统启动目录，保存和系统启动相关的文件，如内核文件和启动引导程序(grub)文件等</td>
</tr>
<tr>
<td>/dev/</td>
<td>设备文件</td>
</tr>
<tr>
<td>/etc/</td>
<td>配置文件，系统内所有采用默认安装方式(rpm安装)的服务配置文件都保存在这</td>
</tr>
<tr>
<td>/home/</td>
<td>普通用户的宿主目录。所有普通用户的宿主目录就是在/home/下建立一个和用户名相同的目录</td>
</tr>
<tr>
<td>/lib/</td>
<td>系统调用的函数库保存位置</td>
</tr>
<tr>
<td>/lost+found/</td>
<td>系统意外崩溃或意外关机时，一些文件碎片会保存在这。启动的时候fsck工具会检查这里，这个目录只在每个分区中出现</td>
</tr>
<tr>
<td>/media/</td>
<td>挂载目录。系统建议用来挂载媒体设备，软盘、光盘等</td>
</tr>
<tr>
<td>/mnt/</td>
<td>挂载目录。建议用来挂载额外设备，U盘，移动硬盘和其他操作系统的分区</td>
</tr>
<tr>
<td>/misc/</td>
<td>挂载目录。建议挂载NFS服务的共享目录</td>
</tr>
<tr>
<td>/tmp/</td>
<td>临时目录，最好每次开机都把目录清空</td>
</tr>
<tr>
<td>/proc/</td>
<td>该目录中的数据并不保存在硬盘上，而是保存在内存中。主要保存系统的内核、进程、外部设备状态和网络状态等。如/proc/cpuinfo保存CPU信息，/proc/devices保存设备驱动列表，/proc/filesystems保存文件系统列表，/proc/net保存网络协议信息</td>
</tr>
<tr>
<td>/sys/</td>
<td>同/proc/也是内存数据，主要保存和内核相关的信息</td>
</tr>
<tr>
<td>/root/</td>
<td>root用户的宿主目录</td>
</tr>
<tr>
<td>/srv/</td>
<td>服务数据，一些服务启动后，可以在该目录保存所需要的数据</td>
</tr>
<tr>
<td>/usr/local/或/opt</td>
<td>手工安装的软件的保存位置</td>
</tr>
<tr>
<td>/usr/</td>
<td>UNIX Software Resource存放系统软件资源</td>
</tr>
<tr>
<td>/usr/lib/</td>
<td>应用程序调用函数库保存位置</td>
</tr>
<tr>
<td>/usr/share/</td>
<td>应用程序的资源文件保存文职，如帮助文档、说明文档和字体目录</td>
</tr>
<tr>
<td>/usr/local/src或/usr/src/或/usr/local/linux</td>
<td>资源包位置，我们手工下载的资源包和内核源码包都可以保存到/usr/src/，也可以把手工下载的放/usr/local/src，把内核资源包放/usr/local/linux</td>
</tr>
<tr>
<td>/var/</td>
<td>动态数据，如缓存、日志、软件运行产生的文件</td>
</tr>
<tr>
<td>/var/lib/</td>
<td>程序运行中需要调用或改变的数据保存位置。如mysql的数据保存在/var/lib/mysql/目录中</td>
</tr>
<tr>
<td>/var/log/</td>
<td>系统日志保存位置</td>
</tr>
</tbody></table>
<p>ps:/proc/、/sys/目录保存在内存中，所以尽量少写入数据，/boot/不存保存额外数据，因为是单独的启动分区，如果没有空闲空间，则会导致系统不能正常启动</p>
<h2 id="3-软件包"><a href="#3-软件包" class="headerlink" title="3. 软件包"></a>3. 软件包</h2><p>源码包——因为要把源代码编译成二进制语言，所以安装的时间较长，但功能可以在源码中自定义。</p>
<p>二进制包——经过编译后的包，因为编译过程在发布之前就完成，所以用户安装时较快。目前主要由两个系列的二进制包管理系统：一个是Red Hat上的 RPM 包管理系统；另一个是Debian和Ubuntu上的 DPKKG 包管理系统</p>
<p>源码包出于发行的需要，我们一般会把源码包打包压缩之后发布，而Linux中最常用的打包压缩格式是”*.tar.gz”</p>
<p><strong>RPM包的rpm安装</strong></p>
<p>RPM包一般会遵守统一的命名规则：软件包名-软件版本-软件发布的次数.软件发行商.xxx.适合的硬件平台.rpm</p>
<p>RPM包一般采用系统默认路径安装，而源码包一般通过手工指定(/usr/local)中</p>
<p>安装:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh 包全名  #安装多个包通过空格分隔</span><br></pre></td></tr></table></figure>
<p>-i : 安装</p>
<p>-v：显示更详细的信息</p>
<p>-h：打印#，显示安装进度</p>
<p>-U：升级安装</p>
<p>-e：卸载</p>
<p>我们安装RPM软件包的时候经常会报依赖性相关的错误Failed dependencies，这时候巨需要在<a target="_blank" rel="noopener" href="http://www.rpmfind.net上找对应库文件所属的软件包,然后安装对应的软件包/">www.rpmfind.net上找对应库文件所属的软件包，然后安装对应的软件包</a></p>
<p><strong>RPM包的yum安装</strong></p>
<p>rpm命令安装很麻烦，尤其是库文件依赖，yum命令自动处理RPM</p>
<p>yum源矿业是使用网络yum源，也可以使用本地光盘作为yum源。</p>
<p>常用命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum search 关键字</span><br><span class="line">yum -y install 包名	# -y：自动回答yes</span><br><span class="line">yum -y update 包名	# 升级</span><br><span class="line">yum remove 包名		# 删除包名</span><br></pre></td></tr></table></figure>











      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/linux/" data-id="ckk50ch9s0007egmzbjcrcr30" data-title="linux" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag">服务器</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-nacos" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/nacos/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/nacos/">nacos</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><p>Nacos致力于帮助您发现，配置和管理您的微服务。它提供了一组简单实用的功能，使您能够实现动态服务发现，服务配置，服务元数据和流量管理。</p>
<p>Nacos使您可以更轻松，更快速地构建，交付和管理您的微服务平台。它是支持以服务为中心的现代应用程序架构的基础架构，具有微服务或云原生方法。</p>
<h1 id="二、什么是Nacos"><a href="#二、什么是Nacos" class="headerlink" title="二、什么是Nacos"></a>二、什么是Nacos</h1><p>服务是Nacos的一流公民。Nacos支持发现，配置和管理几乎所有类型的服务：</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes服务</a></p>
<p><a target="_blank" rel="noopener" href="https://grpc.io/docs/guides/concepts.html#service-definition">gRPC</a>和<a target="_blank" rel="noopener" href="https://dubbo.incubator.apache.org/">Dubbo RPC服务</a></p>
<p><a target="_blank" rel="noopener" href="https://spring.io/understanding/REST">Spring Cloud RESTful服务</a></p>
<p>Nacos的主要特点：</p>
<p><strong>服务发现和服务健康检查</strong></p>
<p>Nacos支持基于DNS和基于RPC（Dubbo / gRPC）的服务发现。在服务提供者使用<a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/sdk.html">本机</a>，<a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/open-API.html">OpenAPI</a>或<a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/other-language.html">专用代理</a>注册服务之后，使用者可以使用<a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/other-language.html">DNS</a>或<a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/other-language.html">HTTP</a>发现服务。</p>
<p>Nacos提供实时运行状况检查，以防止服务向不健康的主机或服务实例发送请求。Nacos支持传输层（PING或TCP）运行状况检查和应用程序层（例如HTTP，Redis，MySQL和用户定义的协议）运行状况检查。对于复杂云和网络拓扑（例如VPC，Edge Service等）的运行状况检查，Nacos提供代理模式和服务器模式运行状况检查。Nacos还提供统一服务运行状况仪表板，以帮助您管理服务的可用性和流量。</p>
<p><strong>动态配置管理</strong></p>
<p>动态配置服务允许您在所有环境中以集中，外部化和动态的方式管理所有应用程序和服务的配置。</p>
<p>动态配置消除了在更新配置时重新部署应用程序和服务的需要。</p>
<p>集中式配置管理使您可以更方便地按需实现无状态服务和弹性扩展服务实例。</p>
<p>Nacos提供<a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/xx">易于使用的UI TODO</a>，可帮助您管理所有应用程序或服务的配置。它提供了一些开箱即用的功能，包括配置版本跟踪，canary / beta版本，配置回滚和客户端配置更新状态跟踪，以确保安全性并控制配置更改的风险。</p>
<p><strong>动态DNS服务</strong></p>
<p>支持加权路由的动态DNS服务使您可以更轻松地在数据中心的生产环境中实施中间层负载平衡，灵活路由策略，流量控制和简单DNS解析服务。动态DNS服务使您可以更轻松地实施基于DNS的服务发现。</p>
<p>Nacos 为您提供了一些简单的<a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/xx">DNS API TODO</a>来管理您的DNS域名和IP。</p>
<p><strong>服务治理和元数据管理</strong></p>
<p>Nacos允许您从微服务平台构建器的角度管理所有服务和元数据。这包括管理服务描述，生命周期，服务静态依赖关系分析，服务运行状况，服务流量管理，路由和安全规则，服务SLA和第一行度量。</p>
<h1 id="三、安装Nacos"><a href="#三、安装Nacos" class="headerlink" title="三、安装Nacos"></a>三、安装Nacos</h1><ol>
<li>到Nacos的稳定版本下载地址，<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases">下载最新版</a></li>
<li>下载后解压</li>
<li>进入bin目录</li>
<li>执行命令nohup sh startup.sh -m standalone &amp;</li>
</ol>
<h1 id="四、Nacos作为注册中心"><a href="#四、Nacos作为注册中心" class="headerlink" title="四、Nacos作为注册中心"></a>四、Nacos作为注册中心</h1><h2 id="1-服务提供方"><a href="#1-服务提供方" class="headerlink" title="1. 服务提供方"></a>1. 服务提供方</h2><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;nacos.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>启用服务发现注解</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>编写配置</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">applicaiton:</span></span><br><span class="line">  	<span class="attr">name:</span> <span class="string">alibaba-nacos-discovery-server</span>	<span class="comment">#注册到nacos上的服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.146</span><span class="number">.220</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>定义提供的方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> </span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;invoked name = &quot;</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello &quot;</span> + name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-服务消费方"><a href="#2-服务消费方" class="headerlink" title="2. 服务消费方"></a>2. 服务消费方</h2><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;nacos.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;nacos.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>启用服务发现注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure></li>
<li><p>使用loadBalancerClient发起请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        LoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 通过spring cloud common中的负载均衡接口选取服务提供节点实现接口调用</span></span><br><span class="line">            ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="string">&quot;alibaba-nacos-discovery-server&quot;</span>);</span><br><span class="line">            String url = serviceInstance.getUri() + <span class="string">&quot;/hello?name=&quot;</span> + <span class="string">&quot;didi&quot;</span>;</span><br><span class="line">            RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">            String result = restTemplate.getForObject(url, String.class);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invoke : &quot;</span> + url + <span class="string">&quot;, return : &quot;</span> + result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置服务名称和Nacos地址，让服务消费者可以发现上面已经注册到Nacos的服务。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">alibaba-nacos-discovery-client-common</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">9000</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.discovery.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br></pre></td></tr></table></figure></li>
<li><p>发起请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9000&#x2F;test</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:9000&#x2F;test</span><br><span class="line">Invoke : http:&#x2F;&#x2F;10.123.18.216:8001&#x2F;hello?name&#x3D;didi, return : hello didi</span><br><span class="line">$ curl localhost:9000&#x2F;test</span><br><span class="line">Invoke : http:&#x2F;&#x2F;10.123.18.216:8002&#x2F;hello?name&#x3D;didi, return : hello didi</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到，两次不同请求的时候，真正实际调用的服务提供者实例是不同的，也就是说，通过<code>LoadBalancerClient</code>接口在获取服务实例的时候，已经实现了对服务提供方实例的负载均衡。但是很明显，这样的实现还是比较繁琐，预告下后面的几篇，关于服务消费的几种不同姿势。</p>
</li>
</ol>
<h2 id="3-支持的几种服务消费方式"><a href="#3-支持的几种服务消费方式" class="headerlink" title="3. 支持的几种服务消费方式"></a>3. 支持的几种服务消费方式</h2><h3 id="3-1-使用Feign"><a href="#3-1-使用Feign" class="headerlink" title="3.1 使用Feign"></a>3.1 使用Feign</h3><ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>定义Feign客户端和使用Feign客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(TestApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Slf4j</span></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        Client client;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            String result = client.hello(<span class="string">&quot;didi&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Return : &quot;</span> + result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@FeignClient(&quot;alibaba-nacos-discovery-server&quot;)</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">        <span class="function">String <span class="title">hello</span><span class="params">(<span class="meta">@RequestParam(name = &quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里主要先通过<code>@EnableFeignClients</code>注解开启扫描Spring Cloud Feign客户端的功能；然后又创建一个Feign的客户端接口定义。使用<code>@FeignClient</code>注解来指定这个接口所要调用的服务名称，接口中定义的各个函数使用Spring MVC的注解就可以来绑定服务提供方的REST接口，比如下面就是绑定<code>alibaba-nacos-discovery-server</code>服务的<code>/hello</code>接口的例子。最后，在Controller中，注入了Client接口的实现，并调用hello方法来触发对服务提供方的调用。关于使用Feign的完整例子也可以通过在文末的仓库中查看。</p>
<h2 id="深入思考"><a href="#深入思考" class="headerlink" title="深入思考"></a>深入思考</h2><p>如果之前已经用过Spring Cloud的读者，肯定会这样的感受：不论我用的是<code>RestTempalte</code>也好、还是用的<code>WebClient</code>也好，还是用的<code>Feign</code>也好，似乎跟我用不用Nacos没啥关系？我们在之前介绍Eureka和Consul的时候，也都是用同样的方法来实现服务调用的，不是吗？</p>
<p>确实是这样，对于Spring Cloud老手来说，就算我们更换了Nacos作为新的服务注册中心，其实对于我们应用层面的代码是没有影响的。那么为什么Spring Cloud可以带给我们这样的完美编码体验呢？实际上，这完全归功于Spring Cloud Common的封装，由于在服务注册与发现、客户端负载均衡等方面都做了很好的抽象，而上层应用方面依赖的都是这些抽象接口，而非针对某个具体中间件的实现。所以，在Spring Cloud中，我们可以很方便的去切换服务治理方面的中间件。</p>
</li>
</ol>
<h1 id="五、-Nacos作为配置中心"><a href="#五、-Nacos作为配置中心" class="headerlink" title="五、 Nacos作为配置中心"></a>五、 Nacos作为配置中心</h1><p>Nacos除了实现了服务的注册发现之外，还将配置中心功能整合在了一起。通过Nacos的配置管理功能，我们可以将整个架构体系内的所有配置都集中在Nacos中存储。这样做的好处，在以往的教程中介绍Spring Cloud Config时也有提到，主要有以下几点：</p>
<ul>
<li>分离的多环境配置，可以更灵活的管理权限，安全性更高</li>
<li>应用程序的打包更为纯粹，以实现一次打包，多处运行的特点（<a target="_blank" rel="noopener" href="http://blog.didispace.com/12factor-zh-cn/">《云原声应用的12要素》之一</a>）</li>
</ul>
<p>Nacos的配置管理模型与淘宝开源的配置中心Diamond类似，基础层面都通过<code>DataId</code>和<code>Group</code>来定位配置内容，除此之外还增加了很多其他的管理功能。</p>
<h2 id="1-创建配置"><a href="#1-创建配置" class="headerlink" title="1. 创建配置"></a>1. 创建配置</h2><p>进入Nacos的控制页面，在配置列表功能页面中，点击右上角的“+”按钮，进入“新建配置”页面，如下图填写内容：</p>
<p><img src="D:\MyNote\images\pasted-144.png" alt="pasted-144"></p>
<p>其中：</p>
<ul>
<li><code>Data ID</code>：填入<code>alibaba-nacos-config-client.properties</code></li>
<li><code>Group</code>：不修改，使用默认值<code>DEFAULT_GROUP</code></li>
<li><code>配置格式</code>：选择<code>Properties</code></li>
<li><code>配置内容</code>：应用要加载的配置内容，这里仅作为示例，做简单配置，比如：<code>didispace.title=spring-cloud-alibaba-learning</code></li>
</ul>
<h2 id="2-创建配置客户端"><a href="#2-创建配置客户端" class="headerlink" title="2. 创建配置客户端"></a>2. 创建配置客户端</h2><ol>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到，这个例子中并没有加入nacos的服务发现模块，所以这两个内容是完全可以独立使用的</p>
</blockquote>
</li>
<li><p>添加配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">alibaba-nacos-config-client</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8001</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.server-addr</span>=<span class="string">192.168.146.220:8848</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>定义一个HTTP接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="meta">@RefreshScope</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Value(&quot;$&#123;didispace.title:&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> title;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>@RefreshScope</code>，主要用来让这个类下的配置内容支持动态刷新，也就是当我们的应用启动之后，修改了Nacos中的配置内容之后，这里也会马上生效。</p>
</li>
</ol>
<h2 id="3-启用配置客户端并验证动态刷新"><a href="#3-启用配置客户端并验证动态刷新" class="headerlink" title="3. 启用配置客户端并验证动态刷新"></a>3. 启用配置客户端并验证动态刷新</h2><p>用curl或者postman等工具，访问接口: <code>localhost:8001/test</code>，一切正常的话，将返回Nacos中配置的<code>spring-cloud-alibaba-learning</code>。然后，再通过Nacos页面，修改这个内容，点击发布之后，再访问接口，可以看到返回结果变了。</p>
<p>在Nacos中修改了Key，在用到这个配置的应用中，也自动刷新了这个配置信息。</p>
<h1 id="六、Nacos多环境管理"><a href="#六、Nacos多环境管理" class="headerlink" title="六、Nacos多环境管理"></a>六、Nacos多环境管理</h1><p>在Nacos中，本身有多个不同管理级别的概念，包括：<code>Data ID</code>、<code>Group</code>、<code>Namespace</code>。只要利用好这些层级概念的关系，就可以根据自己的需要来实现多环境的管理。</p>
<h2 id="1-使用Data-ID与profiles实现"><a href="#1-使用Data-ID与profiles实现" class="headerlink" title="1. 使用Data ID与profiles实现"></a>1. 使用Data ID与profiles实现</h2><p>在Nacos中我们创建的配置如下</p>
<ul>
<li><code>Data ID</code>：alibaba-nacos-config-client-DEV.properties</li>
<li><code>Group</code>：DEFAULT_GROUP</li>
</ul>
<p>对应的配置文件的参数如下：</p>
<ul>
<li>Data ID中的<code>alibaba-nacos-config-client</code>：对应客户端的配置<code>spring.cloud.nacos.config.prefix</code>，默认值为<code>$&#123;spring.application.name&#125;</code>，即：服务名</li>
<li>Data ID中的<code>DEV</code>：对应客户端的配置<code>spring.profiles.active</code>,不写则只有服务名</li>
<li>Data ID中的<code>properties</code>：对应客户端的配置<code>spring.cloud.nacos.config.file-extension</code>，默认值为<code>properties</code></li>
<li>Group的值<code>DEFAULT_GROUP</code>：对应客户端的配置<code>spring.cloud.nacos.config.group</code>，默认值为<code>DEFAULT_GROUP</code></li>
</ul>
<h2 id="2-通过Group"><a href="#2-通过Group" class="headerlink" title="2. 通过Group"></a>2. 通过Group</h2><p><code>Group</code>在Nacos中是用来对<code>Data ID</code>做集合管理的重要概念。所以，如果我们把一个环境的配置视为一个集合，那么也就可以实现不同环境的配置管理。对于<code>Group</code>的用法并没有固定的规定，所以我们在实际使用的时候，需要根据我们的具体需求，可以是架构运维上对多环境的管理，也可以是业务上对不同模块的参数管理。为了避免冲突，我们需要在架构设计之初，做好一定的规划。这里，我们先来说说如何用<code>Group</code>来实现多环境配置管理的具体实现方式。</p>
<ol>
<li><p>在Nacos管控台中设置配置的Group</p>
</li>
<li><p>在配置文件中指定使用的Group</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.nacos.config.group</span>=<span class="string">DEV_GROUP</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="3-通过NameSpace"><a href="#3-通过NameSpace" class="headerlink" title="3. 通过NameSpace"></a>3. 通过NameSpace</h2></li>
</ol>
<p>先来看看官方的概念说明：用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的<code>Group</code>或<code>Data ID</code>的配置。<code>Namespace</code>的常用场景之一是不同环境的配置的区分隔离，例如：开发测试环境和生产环境的资源（如配置、服务）隔离等。</p>
<ol>
<li>在Nacos管控台中创建命名空间<code>DEV</code>和<code>TEST</code></li>
<li>分别在<code>DEV</code>和<code>TEST</code>空间下为<code>alibaba-nacos-config-client</code>应用创建配置内容</li>
<li>在<code>alibaba-nacos-config-client</code>应用的配置文件中，增加<code>Namespace</code>的指定配置，比如：<code>spring.cloud.nacos.config.namespace=83eed625-d166-4619-b923-93df2088883a</code></li>
</ol>
<p>ps:配置的使用使用namespace的id而不是名称</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>Group：区分业务层面的分组</p>
<p>NameSpace： 区分不同环境</p>
<p>DataID：区分一格业务下的不同项目</p>
<h1 id="七、数据持久化解决集群数据一致性"><a href="#七、数据持久化解决集群数据一致性" class="headerlink" title="七、数据持久化解决集群数据一致性"></a>七、数据持久化解决集群数据一致性</h1><h2 id="1-在MySQL中执行nacos-mysql-sql文件"><a href="#1-在MySQL中执行nacos-mysql-sql文件" class="headerlink" title="1. 在MySQL中执行nacos-mysql.sql文件"></a>1. 在MySQL中执行nacos-mysql.sql文件</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/nacos/" data-id="ckk50ch9s0008egmz1wak2m7s" data-title="nacos" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">框架及中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-rockermq宕机及重复消费问题" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/20/rockermq%E5%AE%95%E6%9C%BA%E5%8F%8A%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98/" class="article-date">
  <time class="dt-published" datetime="2021-01-19T16:00:00.000Z" itemprop="datePublished">2021-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/20/rockermq%E5%AE%95%E6%9C%BA%E5%8F%8A%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98/">RocketMq宕机及重复消费问题</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、宕机"><a href="#一、宕机" class="headerlink" title="一、宕机"></a>一、宕机</h1><ul>
<li><p>消息消费的具体流程是什么？<br>rocketmq消息是pull模式，如果master正常，则从master上拉取消息；如果master挂掉，会从slave上拉取消息（虽然slave不能写消息，但是可用写消费进度）<br>在broker和消费端都正常的情况下，消费端在拉取到消息后，<br>每消费完一批消息（批的大小consumeMessageBatchMaxSize在DefaultMQPushConsumer中可以设置，默认是1），就会把消息进度写到消费端的内存中，<br>然后是定时（persistConsumerOffsetInterval，默认每隔5秒）向broker发起请求写这个MessageQueue的消息进度（如果没同步消费端就宕机可能导致重复消费）<br>broker拿到某个topic下的messageQueue消费进度会存到内存，然后定时持久化到文件中。（如果没有持久化就宕机可能导致重复消费）<br>如果消费端抛异常，消费端也会消费进度+1，但会向broker发送retry主题的消息（以%RETRY%开头的主题），消费端这么做的目的是不阻碍消费进度，有错误先提交进度，出错的消息挪到后面去消费</p>
</li>
<li><p>如果broker(指master)宕机，消费端会怎么样？<br>如果消费端消费成功，则提交不了消费进度，如果消费失败，消费进度和重试的主题消息都写不成功。没发送成功的消息消费端会放入processQueue继续消费。所以会导致无限发消息重复消费的情况，直到broker启动或者消费端关闭</p>
</li>
<li><p>虽然master挂了，但如果有slave会怎么样？</p>
<p>当master停机时，消费者会从slave上拉取消息进行消费，会提交消费进度到slave上。但如果消费时发生异常，向slave发送retry主题，因为slave不接受写消息，也会导致消费端无限重复消费的情况</p>
</li>
<li><p>rocketmq的数据持久化流程是什么</p>
<p>producer发送的消息会顺序写入CommitLog中，CommitLog每个文件最大1GB，写满后会创建新的CommitLog，消息写入的时候，不是直接写入磁盘，而是先写入到os cache中，然后操作系统调度线程通过<strong>异步刷盘</strong>将缓存中的数据写入磁盘（异步刷盘的性能非常高，如果需要确保消息不会丢失，还是要采用同步刷盘策略）</p>
<h1 id="二、重复消费"><a href="#二、重复消费" class="headerlink" title="二、重复消费"></a>二、重复消费</h1><h2 id="1-rocketmq什么情况下会发生重复消费？"><a href="#1-rocketmq什么情况下会发生重复消费？" class="headerlink" title="1. rocketmq什么情况下会发生重复消费？"></a>1. rocketmq什么情况下会发生重复消费？</h2></li>
</ul>
<p>可以根据rocketmq的消费流程看到重复消费的情况：</p>
<p>rocketmq消息是pull模式，如果master正常，则从master上拉取消息；如果master挂掉，会从slave上拉取消息（虽然slave不能写消息，但是可用写消费进度）消费端每次会拉取一批消息，如果offset为1的消息处理很慢，而之后的消息虽然已经处理完了，但还是无法提交（因为下标提交从小到大），这时候消费端宕机，因为消费进度没有提交，会导致除1之外的消息被重复消费<br>在broker和消费端都正常的情况下，消费端在拉取到消息后，每消费完一批消息（批的大小consumeMessageBatchMaxSize在DefaultMQPushConsumer中可以设置，默认是1），就会把消息进度写到消费端的内存中，然后是定时（persistConsumerOffsetInterval，默认每隔5秒）向broker发起请求写这个MessageQueue的消息进度（<em>如果没同步消费端就宕机可能导致重复消费</em>）<br>broker拿到某个topic下的messageQueue消费进度会存到内存，然后定时持久化到文件中。（<em>如果没有持久化就宕机可能导致重复消费</em>）<br>如果消费端抛异常，消费端也会消费进度+1，如果是集群消费，默认情况下还会向broker发送retry主题的消息（以%RETRY%开头的主题），广播消费不会发送retry主题。消费端这么做的目的是不阻碍消费进度，有错误先提交进度，出错的消息挪到后面去消费(<em>但出错可能导致部分代码重复消费，所以需要使用try捕获异常</em>)</p>
<p>另外，如果broker(这里指master)宕机，消费者将提交不了消费进度，没发送成功的消息消费端会放入processQueue继续消费，所以会导致无限发消息重复消费的情况，直到broker启动或者消费端关闭。如果master宕机但存在对应的slave，消费者会从slave上拉取消息进行消费，会提交消费进度到slave上。但如果消费时发生异常，向slave发送retry主题，因为slave不接受写消息，也会导致消费端无限重复消费的情况</p>
<h2 id="2-保证消息不被重复消费的方案"><a href="#2-保证消息不被重复消费的方案" class="headerlink" title="2. 保证消息不被重复消费的方案"></a>2. 保证消息不被重复消费的方案</h2><ol>
<li>消费端处理消息的业务逻辑保持幂等性</li>
<li>保证每条消息都有唯一编号且保证消息处理成功与去重表的日志同时出现<ul>
<li>首先在数据库中新增一张去重表(id,发送时间，消费状态，错误信息)</li>
<li>发送端：消息中使用IdGen生成唯一主键(只能保存到消息体中，因为消费时只能拿到消息体)<br><code>异步发送、同步发送</code> - 在发送前保存到去重表，状态为待发送（保存失败也不会发送消息，保存成功发送失败可以定时清理发送时间过久的状态为未消费的消息）<br><code>事务消息发送</code> - 定义一个事务执行器(实现LocalTransactionExecuter接口)，在消息发送成功后此时消息状态为PREPARED（消费端不会消费该状态数据），然后回调实现LocalTransactionExecuter接口的方法（保存消息到去重表），然后消息对消费端可见</li>
<li>消费端：根据消息中的主键和未消费状态修改数据为已消费，获取受影响的行数（如果是1则执行消费逻辑，如果是0则不执行逻辑，需要配置数据库连接?useAffectedRows=true才能返回影响行数），另外为了避免消费失败导致的重试（默认情况下集群消息会重试，广播消息不会重试，可能导致部分代码重复消费的情况），需要捕获消费端的异常。在try代码块最后删除对应的记录（消费成功），在catch块中修改状态为消费失败，并添加错误信息</li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/20/rockermq%E5%AE%95%E6%9C%BA%E5%8F%8A%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98/" data-id="ckk50ch9t0009egmz9m7881tn" data-title="RocketMq宕机及重复消费问题" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">框架及中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E5%9F%BA%E7%A1%80/" rel="tag">java基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag">服务器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">框架及中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/java%E5%9F%BA%E7%A1%80/" style="font-size: 16.67px;">java基础</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 10px;">大数据</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" style="font-size: 13.33px;">服务器</a> <a href="/tags/%E6%A1%86%E6%9E%B6%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 20px;">框架及中间件</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">测试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/20/Arthas/">Arthas</a>
          </li>
        
          <li>
            <a href="/2021/01/20/COLA/">COLA</a>
          </li>
        
          <li>
            <a href="/2021/01/20/HazelCast%E3%80%81Ignite/">HazelCast、Ignite</a>
          </li>
        
          <li>
            <a href="/2021/01/20/Shiro%E3%80%81Spring%20Security/">Shiro、Spring Security</a>
          </li>
        
          <li>
            <a href="/2021/01/20/cucumber/">cucumber</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>